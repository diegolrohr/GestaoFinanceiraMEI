<script>
    @Html.Partial("Functions/_fnMain");

    function fnFormReadyVisualizarOrdemVenda() {
        listProdutos();
        listServicos();
        calculaTotalOrdemVenda();
        collapseCadastro();
        if ($('#fly01mdlfrmVisualizarOrdemVenda #exibeStepProdutos').val() == "True") {
            collapseProdutos();
        }
        if ($('#fly01mdlfrmVisualizarOrdemVenda #exibeStepServicos').val() == "True") {
            collapseServicos();
        }
        collapseFinanceiro();
        if ($('#fly01mdlfrmVisualizarOrdemVenda #exibeStepTransportadora').val() == "True") {
            collapseTransporte();
        }
        collapseTotais();

        $('#fly01mdlfrmVisualizarOrdemVenda .collapsible').collapsible();
        expandInitialCollapse();
    }

    function expandInitialCollapse() {
        $("#fly01mdlfrmVisualizarOrdemVenda #collapseCadastroField .collapsible-header").addClass("active");
        $("#fly01mdlfrmVisualizarOrdemVenda #collapseCadastroField .collapsible").collapsible({ accordion: false });
        if ($('#exibeStepProdutos').val() == "True") {
            $("#fly01mdlfrmVisualizarOrdemVenda #collapseProdutosField .collapsible-header").addClass("active");
            $("#fly01mdlfrmVisualizarOrdemVenda #collapseProdutosField .collapsible").collapsible({ accordion: false });
        }
        else{
            $("#fly01mdlfrmVisualizarOrdemVenda #collapseServicosField .collapsible-header").addClass("active");
            $("#fly01mdlfrmVisualizarOrdemVenda #collapseServicosField .collapsible").collapsible({ accordion: false });
        }
    }

    function collapseCadastro() {
        var elements = [];
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #numeroField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #dataField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #tipoVendaField')[0]);

        if ($('#fly01mdlfrmVisualizarOrdemVenda #emiteNotaFiscal').val() == "True") {
            elements.push($('#fly01mdlfrmVisualizarOrdemVenda #nFeRefComplementarIsDevolucaoField')[0]);
            elements.push($('#fly01mdlfrmVisualizarOrdemVenda #tipoNfeComplementarField')[0]);
            elements.push($('#fly01mdlfrmVisualizarOrdemVenda #chaveNFeReferenciadaField')[0]);
        }

        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #clienteIdField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #observacaoField')[0]);

        $("#collapseCadastroField").append(createElem("ul",
              { "class": "collapsible", "data-collapsible": "accordion" },
              createElem("li", null, [
                  createElem("div", { "class": "collapsible-header" }, createElem("h6", { "class": "orange-text light" }, "Cadastro")),
                  createElem("div", { "class": "collapsible-body" }, createElem("div", { "class": "row" }, elements))
              ])
          ));
    };

    function collapseProdutos() {
        var elements = [];
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #ordemVendaProdutosDataTableField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalProdutosDtField')[0]);
        
        $("#collapseProdutosField").append(createElem("ul",
              { "class": "collapsible", "data-collapsible": "accordion" },
              createElem("li", null, [
                  createElem("div", { "class": "collapsible-header" }, createElem("h6", { "class": "orange-text light" }, "Produtos")),
                  createElem("div", { "class": "collapsible-body" }, createElem("div", { "class": "row" }, elements))
              ])
          ));
    };

    function collapseServicos() {
        var elements = [];
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #ordemVendaServicosDataTableField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalServicosDtField')[0]);

        $("#collapseServicosField").append(createElem("ul",
              { "class": "collapsible", "data-collapsible": "accordion" },
              createElem("li", null, [
                  createElem("div", { "class": "collapsible-header" }, createElem("h6", { "class": "orange-text light" }, "Serviços")),
                  createElem("div", { "class": "collapsible-body" }, createElem("div", { "class": "row" }, elements))
              ])
          ));
    };

    function collapseFinanceiro() {
        var elements = [];
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #formaPagamentoIdField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #condicaoParcelamentoIdField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #categoriaIdField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #centroCustoIdField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #dataVencimentoField')[0]);

        $("#collapseFinanceiroField").append(createElem("ul",
              { "class": "collapsible", "data-collapsible": "accordion" },
              createElem("li", null, [
                  createElem("div", { "class": "collapsible-header" }, createElem("h6", { "class": "orange-text light" }, "Financeiro")),
                  createElem("div", { "class": "collapsible-body" }, createElem("div", { "class": "row" }, elements))
              ])
          ));
    };

    function collapseTransporte() {
        var elements = [];
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #tipoFreteField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #transportadoraIdField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #placaVeiculoField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #estadoPlacaVeiculoIdField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #valorFreteField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #pesoBrutoField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #marcaField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #pesoLiquidoField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #quantidadeVolumesField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #tipoEspecieField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #numeracaoVolumesTransField')[0]);

        $("#collapseTransporteField").append(createElem("ul",
              { "class": "collapsible", "data-collapsible": "accordion" },
              createElem("li", null, [
                  createElem("div", { "class": "collapsible-header" }, createElem("h6", { "class": "orange-text light" }, "Transporte")),
                  createElem("div", { "class": "collapsible-body" }, createElem("div", { "class": "row" }, elements))
              ])
          ));
    };

    function collapseTotais() {
        var elements = [];

        if ($('#fly01mdlfrmVisualizarOrdemVenda #exibeStepProdutos').val() == "True") {
            elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalProdutosField')[0]);
            if ($('#emiteNotaFiscal').val() == "True") {
                elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalImpostosProdutosField')[0]);
                elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalImpostosProdutosNaoAgregaField')[0]);
            }
        }

        if ($('#fly01mdlfrmVisualizarOrdemVenda #exibeStepServicos').val() == "True") {
            elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalServicosField')[0]);
            if ($('#emiteNotaFiscal').val() == "True") {
                elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalRetencoesServicosField')[0]);
                elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalImpostosServicosNaoAgregaField')[0]);
            }
        }
        
        if ($('#fly01mdlfrmVisualizarOrdemVenda #exibeStepTransportadora').val() == "True") { elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalFreteField')[0]); }
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #totalOrdemVendaField')[0]);

        if ($('#fly01mdlfrmVisualizarOrdemVenda #emiteNotaFiscal').val() == "True") { elements.push($('#fly01mdlfrmVisualizarOrdemVenda #naturezaOperacaoField')[0]); }
        
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #movimentaEstoqueField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #geraNotaFiscalField')[0]);
        elements.push($('#fly01mdlfrmVisualizarOrdemVenda #geraFinanceiroField')[0]);

        $("#collapseTotaisField").append(createElem("ul",
              { "class": "collapsible", "data-collapsible": "accordion" },
              createElem("li", null, [
                  createElem("div", { "class": "collapsible-header" }, createElem("h6", { "class": "orange-text light" }, "Totais")),
                  createElem("div", { "class": "collapsible-body" }, createElem("div", { "class": "row" }, elements))
              ])
          ));
    };

    function listProdutos() {
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetOrdemVendaProdutos", "OrdemVendaProduto")?id=" + $('#fly01mdlfrmVisualizarOrdemVenda #id').val(),
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response) {
                    $("#ordemVendaProdutosDataTable").DataTable().destroy();

                    var table = $("#ordemVendaProdutosDataTable").DataTable({
                        bSort: false,
                        paging: false,
                        bLengthChange: false,
                        searching: false,
                        ordering: false,
                        info: false,
                        data: response.data,
                        columns: [
                            { title: "Produto", data: "produto_descricao" },
                            { title: "Grupo Tributário", data: "grupoTributario_descricao" },
                            { title: "Quant.", data: "quantidade" },
                            { title: "Valor", data: "valor" },
                            { title: "Desconto", data: "desconto" },
                            { title: "Total", data: "total" }
                        ]
                    });
                } else {
                    $$$.toast(response.message, 'error');
                }
            },
            error: function (jXHR, textStatus, errorThrown) {
                $$$.toast(errorThrown, 'error');
            }
        });
    }

    function listServicos() {
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetOrdemVendaServicos", "OrdemVendaServico")?id=" + $('#fly01mdlfrmVisualizarOrdemVenda #id').val(),
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response) {
                    $("#ordemVendaServicosDataTable").DataTable().destroy();

                    var table = $("#ordemVendaServicosDataTable").DataTable({
                        bSort: false,
                        paging: false,
                        bLengthChange: false,
                        searching: false,
                        ordering: false,
                        info: false,
                        data: response.data,
                        columns: [
                            { title: "Serviço", data: "servico_descricao" },
                            { title: "Grupo Tributário", data: "grupoTributario_descricao" },
                            { title: "Quant.", data: "quantidade" },
                            { title: "Valor", data: "valor" },
                            { title: "Desconto", data: "desconto" },
                            { title: "Outras Retenções", data: "valorOutrasRetencoes" },
                            { title: "Total", data: "total" }
                        ]
                    });
                } else {
                    $$$.toast(response.message, 'error');
                }
            },
            error: function (jXHR, textStatus, errorThrown) {
                $$$.toast(errorThrown, 'error');
            }
        });
    }

    function calculaTotalOrdemVenda() {
        var valorFrete = 0;
        var tipoFrete = $('#fly01mdlfrmVisualizarOrdemVenda #tipoFrete').val();
        var tipoVenda = $('#fly01mdlfrmVisualizarOrdemVenda #tipoVenda').val();
        var tipoNfeComplementar = $('#fly01mdlfrmVisualizarOrdemVenda #tipoNfeComplementar').val();
        var somaFrete = (
                (tipoFrete == "FOB" || tipoFrete == "Destinatario") && $('input#exibeStepTransportadora').val() == "True"
            );

        if (somaFrete) {
            valorFrete = TryParseFloat(noComma($('input#valorFrete').val()));
        }

        var idPedido = $("form#fly01mdlfrmVisualizarOrdemVenda input#id").val();
        var idCliente = $("form#fly01mdlfrmVisualizarOrdemVenda input#clienteId").val();
        var geraNotaFiscal = $('input#geraNotaFiscal:checked').val() == "true";

        $$$.loading.start();

        $.ajax({
            url: '@Url.Action("TotalOrdemVenda", "OrdemVenda")',
            type: "GET",
            data: { id: idPedido, clienteId: idCliente, geraNotaFiscal: geraNotaFiscal, tipoNfeComplementar: tipoNfeComplementar, tipoFrete: tipoFrete, valorFrete: valorFrete }
        })
        .done(function (data) {
            if (data.success) {
                $('input#totalProdutos').val(data.total.TotalProdutos.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosProdutos').val(data.total.TotalImpostosProdutos.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosProdutosNaoAgrega').val(data.total.TotalImpostosProdutosNaoAgrega.formatMoneyMask(2, 3, '', ','));
                $('input#totalServicos').val(data.total.TotalServicos.formatMoneyMask(2, 3, '', ','));
                $('input#totalRetencoesServicos').val(data.total.TotalRetencoesServicos.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosServicosNaoAgrega').val(data.total.TotalImpostosServicosNaoAgrega.formatMoneyMask(2, 3, '', ','));
                $('input#totalFrete').val(data.total.ValorFrete.formatMoneyMask(2, 3, '', ','));
                $('input#totalOrdemVenda').val(data.total.Total.formatMoneyMask(2, 3, '', ','));
                $('input#totalProdutosDt').val(data.total.TotalProdutos.formatMoneyMask(2, 3, '', ','));
                $('input#totalServicosDt').val(data.total.TotalServicos.formatMoneyMask(2, 3, '', ','));
                $$$.fn.updateTextFields();
            }
            else {
                $$$.fn.submitErrorHandler(null, data.message);
            }
            $$$.loading.stop();
        })
        .fail(function (jqxhr, textStatus, error) {
            var err = 'Ocorreu um erro na requisição: ' + textStatus + ", " + error;
            $$$.toast(err, "error");
            $$$.loading.stop();
        });
    }

</script>