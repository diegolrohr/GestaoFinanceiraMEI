<script>
    @Html.Partial("Functions/_fnMain");

    function fnFormReadyVisualizarOrcamento() {
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetOrcamentoItens", "OrcamentoItem")?id=" + $('#fly01mdlfrmOrcamento #id').val(),
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response) {
                    $("#orcamentoItensDataTable").DataTable().destroy();

                    var table = $("#orcamentoItensDataTable").DataTable({
                        bSort: false,
                        paging: false,
                        bLengthChange: false,
                        searching: false,
                        ordering: false,
                        info: false,
                        data: response.data,
                        columns: [
                            { title: "Produto", data: "produto_descricao" },
                            { title: "Fornecedor", data: "fornecedor_nome" },
                            { title: "Quant.", data: "quantidade" },
                            { title: "Valor", data: "valor" },
                            { title: "Desconto", data: "desconto" },
                            { title: "Total", data: "total" }
                        ],
                        footerCallback: function (tfoot, data, start, end, display) {
                            var api = this.api(), data;
                            var displayTotal = '';

                            if (data.length > 1) {
                                var total = api
                                    .column(5)
                                    .data()
                                    .reduce(function (a, b) {
                                        var aFloat = typeof a === 'number' ? a : a.removeMoneyMask();
                                        var bFloat = typeof b === 'number' ? b : b.removeMoneyMask();

                                        return aFloat + bFloat;
                                    });

                                displayTotal = total.formatMoneyMask(2, 3, '', ',');
                            } else {
                                if (!!data[0])
                                    displayTotal = data[0].total.replace('R$ ', '').replace('R$', '');
                                else
                                    displayTotal = "0,00"
                            }

                            if (displayTotal.indexOf(',') < 0) {
                                displayTotal += ',00';
                            }

                            $(tfoot).find('th').eq(0).html("Total: R$" + displayTotal);
                    }
                    });
                } else {
                    $$$.toast(response.message, 'error');
                }
            },
            error: function (jXHR, textStatus, errorThrown) {
                $$$.toast(errorThrown, 'error');
            }
        });
    }
</script>