<script>
    @Html.Partial("Functions/_fnMain");

    function calculaTotalNFeTransmitir() {
        var idNFe = $("form#fly01mdlfrmTransmitirNFe input#idNFe").val();
        $$$.loading.start();

        $.ajax({
            url: '@Url.Action("TotalNotaFiscal", "NotaFiscal")',
            type: "GET",
            data: { id: idNFe }
        })
        .done(function (data) {
            if (data.success) {
                $('input#totalProdutos').val(data.total.TotalProdutos.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosProdutos').val(data.total.TotalImpostosProdutos.formatMoneyMask(2, 3, '', ','));
                $('form#fly01mdlfrmTransmitirNFe input#totalFreteNFe').val(data.total.ValorFrete.formatMoneyMask(2, 3, '', ','));
                $('form#fly01mdlfrmTransmitirNFe input#totalNotaFiscalNFe').val(data.total.Total.formatMoneyMask(2, 3, '', ','));
                $$$.fn.updateTextFields();
            }
            else {
                $$$.fn.submitErrorHandler(null, data.message);
            }
            $$$.loading.stop();
        })
        .fail(function (jqxhr, textStatus, error) {
            var err = 'Ocorreu um erro na requisição: ' + textStatus + ", " + error;
            $$$.toast(err, "error");
            $$$.loading.stop();
        });
    }

    function fnOverrideSubmit() {

        var myForm = "form#fly01mdlfrmTransmitirNFe";

        $(myForm).off("submit");
        $(myForm).on("submit", function (e) {
            var that = $(myForm)

            if (!that.valid())
                return false;
            e.preventDefault();
            $$$.loading.start();
            var formData = that.serializeObject();
            $.ajax({
                type: that.attr("method"),
                contentType: 'application/json',
                dataType: 'json',
                url: that.attr("action"),
                data: JSON.stringify(formData),
                success: function (data) {
                    if (data.success) {
                        $$$.toast(data.message, "success");

                        $$$._.fly01dt.refresh();

                        $$$._.fly01mdlfrmTransmitirNFe.close();

                    } else {
                        $$$.loading.stop();
                        $$$.fn.submitErrorHandler(null, data.message);
                    }
                    $$$.loading.stop();
                },
                error: function error(jXHR, textStatus) {
                    $$$.toast(textStatus, "error");
                    $$$.loading.stop();
                }
            })
        });
    };

    function fnFormReadyTransmitirNFe() {
        calculaTotalNFeTransmitir();
        fnOverrideSubmit();
    }
</script>