<script>
    function isCreate() {
        var idSelector = "input#id";
        var id = $(idSelector).val();

        if (id.length == 0)
            return true;

        return false;
    }

    function fnBindOverrideSubmit() {
        //substitui comportamento normal
        $("form#fly01frm").off("submit");
        $("form#fly01frm").on("submit", function (e) {
            $('body').removeClass('loaded');

            e.preventDefault();

            var fileUpload = $("#arquivo").get(0);

            if (isCreate() && fileUpload.files.length == 0)
            {
                $$$.toast("Arquivo do extrato não enviado", "error");
                $('body').addClass('loaded');
                return;
            }

            var files = fileUpload.files;

            var formData = new FormData();

            formData.append("id", $("input#id").val());
            formData.append("contaBancariaId", $("#contaBancariaId").val());

            for (var i = 0; i < files.length; i++) {
                formData.append(files[i].name, files[i]);
            }

            //https://www.mkyong.com/jquery/jquery-ajax-submit-a-multipart-form/
            $.ajax({
                type: "POST",
                //enctype: 'multipart/form-data',
                url: $(this).attr("action"),
                data: formData,
                processData: false, //it prevent jQuery form transforming the data into a query string
                contentType: false,
                cache: false,
                success: function (data) {
                    if (data.success) {
                        var strMsg = "Cadastrado com sucesso.";
                        if (data.message !== "") strMsg = data.message;
                        $$$.toast(strMsg, "success");

                        var url = "@Url.Action("List", "ConciliacaoBancaria")";
                        if (isCreate()) {
                            $$$.go(url);
                        } else {
                            $$$._.dtConciliacaoItens.refresh();
                            $("#arquivo").val("");
                            $("#arquivoField .file-path").val("");
                        }
                    } else {
                        $$$.toast(data.message, "error");
                    }

                    $('body').addClass('loaded');
                },
                error: function error(jXHR, textStatus) {
                    $$$.toast(textStatus, "error");
                    $('body').addClass('loaded');
                }
            });
        });
    }

    function fnFormReady() {
        fnBindOverrideSubmit();
        if (isCreate()){
            $('#dtConciliacaoItens_wrapper').hide();
            $('#extratoLancamentosLabelField').hide();
        }
        else {
            $('#extratoLancamentosLabelField').show();
            $('#contaBancariaNomeConta').attr('disabled', 'disabled');
            $$$._.dtConciliacaoItens.refresh();
        }
    }
</script>