<script>
    function fnEnviarEmail(data, type, row, meta) {
        var idBanco = "";
        if ($('#bancoId').val() !== undefined)
            idBanco = $('#bancoId').val();
        else
            idBanco = $('#idContaBancaria').val();

        $$$._.dtBoletos.selected = $("#ids").val().split(",");

        if ($$$._.dtBoletos.selected.length > 0) {
            fnSendMails();
        } else {
            $.ajax({
                type: "GET",
                dataType: "json",
                url: '@Url.Action("ValidaBoletoJaGeradoParaOutroBanco", "Cnab")',
                contentType: "application/json",
                data: { contaReceberId: $('#idContaReceber').val(), contaBancariaId: idBanco},
                success: function success(result) {
                    if (result.success) {
                        if (result.data !== null)
                            $$$.confirm("Boleto já gerado para outro banco.", "Já existe um boleto gerado para esta conta em outro banco e está vinculado a um arquivo de remessa, gostaria que este boleto seja remetido novamente?", "fnConfirmedOrCancel('" + $('#idContaReceber').val() + "', '" + idBanco + "')");
                        else
                            fnGerarCnabEnviaEmail($('#idContaReceber').val(), idBanco, true, $('#email').val(), $("#assunto").val(), $("#mensagem").val() );
                    }
                    else
                        fnGerarCnabEnviaEmail($('#idContaReceber').val(), idBanco, true, $('#email').val(), $("#assunto").val(), $("#mensagem").val() );
                }
            });
        }
    }

    function fnSendMails() {
        $$$.loading.start();
        $.ajax({
            type: "POST",
            dataType: "json",
            url: '@Url.Action("GerarBoletoEnviaEmailsSelecionados", "Cnab")',
            data: { idsCnab: $$$._.dtBoletos.selected,  reimprimeBoleto: true, email: $('#email').val(), assunto: $("#assunto").val(), mensagem: $("#mensagem").val() },
            success: function success(data) {
                if (data.success) {
                    $(".selected").removeClass("selected");
                    $$$._.dtBoletos.selected = [];

                    $$$.toast("Boleto gerado e e-mail enviado com sucesso.", "success");
                    if (data.message !== "" && data.message !== undefined) {
                        var win = window.open("", "_blank");
                        win.document.write(data.message);
                        setTimeout(function () {
                            win.print();
                            win.close();
                        }, 10);
                    }
                } else {
                    $$$.loading.stop();
                    $$$.toast(data.message, "error");
                }
                $$$._.fly01mdlfrmModalConfigEmail.close();
                $$$.loading.stop();
            }
        });
    }     

    function fnConfirmedOrCancel(idRecord, contaBancariaId) {
        reemprime = true;
        fnSaveCnab(idRecord, contaBancariaId, reemprime);
    }

    function fnGerarCnabEnviaEmail(idRecord, contaBancariaId, reimprime, pEmail, pAssunto, pMensagem) {
        $$$.loading.start();
        $.ajax({
            type: "GET",
            dataType: "json",
            url: '@Url.Action("GerarBoletoEnviaEmail", "Cnab")',
            contentType: "application/json",
            data: { contaReceberId: idRecord, contaBancariaId: contaBancariaId, reimprimeBoleto: reimprime, email: pEmail, assunto: pAssunto, mensagem: pMensagem},
            success: function success(data) {
                if (data.success) {
                    $$$.toast("Boleto gerado e e-mail enviado com sucesso.", "success");
                    if (data.message !== "" && data.message !== undefined) {
                        var win = window.open("", "_blank");
                        win.document.write(data.message);

                        setTimeout(function () {
                            win.print();
                            win.close();
                        }, 10);
                    }
                } else {
                    $$$.loading.stop();
                    $$$.toast(data.message, "error");
                }
                $$$._.fly01mdlfrmModalConfigEmail.close();
                $$$.loading.stop();
            }
        });
    }
</script>