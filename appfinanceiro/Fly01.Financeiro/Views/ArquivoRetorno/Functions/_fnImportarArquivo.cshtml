<script>
    function fnImportarArquivo(input) {
        if (!window.FileReader) return;
        if (($('#bancoNome').val() == "") || ($('#arquivo').val() == "")) return;

        var reader = new FileReader();
        reader.readAsText($("#arquivo")[0].files[0]);

        reader.onload = processData;
        reader.onerror = errorHandler;
        $("#dtRetornoCnabItem").show();
    }

    function processData(event) {
        $$$.loading.start();
        var ret = event.target.result;

        $.ajax({
            type: "POST",
            url: "@Url.Action("ImportaArquivoRetorno")",
            data: { valueArquivo: ret, contaBancariaId: $('#contaBancariaId').val()},
            success: function (response) {
                if (response.success) {
                    $("#dtRetornoCnabItem").DataTable().destroy();
                    var table =  $("#dtRetornoCnabItem").DataTable({
                        bSort: false,
                        paging: false,
                        bLengthChange: false,
                        searching: false,
                        ordering: false,
                        info: false,
                        select: {
                            style: 'multi'
                        },
                        data: response.data,
                        columns: [
                            { title: "Id", data: "Id", visible: false },
                            { title: "Conta ReceberID", data: "contaReceberId", visible: false },
                            { title: "IdContaBancaria", data: $('#contaBancariaId').val(), visible: false },
                            { title: "Banco", data: "banco_nome" },
                            { title: "Cliente", data: "pessoa_nome" },
                            { title: "Valor", data: "valorBoleto" },
                            { title: "Data Vencimento", data: "dataVencimento" }]
                    });
                    $("#dtRetornoCnabItem_wrapper").addClass("dataTables_wrapper");
                    setupGridSelectEvents(table)
                } else {
                    $$$.toast(response.message, 'error');
                }

                $$$.loading.stop();
            },
            error: function (jXHR, textStatus, errorThrown) {
                $$$.loading.stop();
                $$$.toast(errorThrown, 'error');
            }
        });
    }


    function setupGridSelectEvents(table) {
        table.on("select", function (e, dt, type, indexes) {
            if (type !== undefined) {
                if (table.rows({ selected: true }).count() > 0)
                    $("#baixar").removeAttr("disabled"); 
            }
        }).on('deselect', function (e, dt, type, indexes) {
            if (type !== undefined) {
                if (table.rows({ selected: true }).count() <= 0)
                    $("#baixar").attr("disabled", "disabled");
            }
        });
    }

    function errorHandler(evt) {
        if (evt.target.error.name == "NotReadableError") {
            alert("Não foi possível ler o arquivo!");
        }
    }
</script>