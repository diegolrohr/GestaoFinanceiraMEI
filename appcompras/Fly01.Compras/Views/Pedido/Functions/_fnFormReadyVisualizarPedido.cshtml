<script>
    @Html.Partial("Functions/_fnMain");

    function noComma(e) {
        return e.replace(',', '.');
    }

    function fnChangeFrete() {
        var valorFrete = parseFloat(noComma($('input#valorFrete').val()));
        var valorTotal = parseFloat(noComma($('input#totalProdutos').val()));

        $('input#totalFrete').val(0);
        if ($('select#tipoFrete').val() == "FOB" || $('select#tipoFrete').val() == "Destinatario") {
            $('input#totalFrete').val(valorFrete);
            valorTotal += valorFrete;
        }
        else if ($('select#tipoFrete').val() == "SemFrete") {
            $('input#valorFrete').val(0);
        }

        $('input#totalPedido').val(valorTotal);
        fly01.core.updateTextFields();
    }

    function fnFormReadyVisualizarPedido() {
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetPedidoItens", "PedidoItem")?id=" + $('#fly01mdlfrmPedido #id').val(),
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response) {
                    $("#pedidoItensDataTable").DataTable().destroy();

                    var table = $("#pedidoItensDataTable").DataTable({
                        bSort: false,
                        paging: false,
                        bLengthChange: false,
                        searching: false,
                        ordering: false,
                        info: false,
                        data: response.data,
                        columns: [
                            { title: "Produto", data: "produto_descricao" },
                            { title: "Quant.", data: "quantidade" },
                            { title: "Valor", data: "valor" },
                            { title: "Desconto", data: "desconto" },
                            { title: "Total", data: "total" }
                        ],
                        footerCallback:function (tfoot, data, start, end, display) {
                            var api = this.api(), data;
                            var displayTotal = '';

                            if (data.length > 1) {
                                var total = api
                                    .column(4)
                                    .data()
                                    .reduce(function (a, b) {
                                        var aFloat = typeof a === 'number' ? a : a.removeMoneyMask();
                                        var bFloat = typeof b === 'number' ? b : b.removeMoneyMask();

                                        return aFloat + bFloat;
                                    });

                                displayTotal = total.formatMoneyMask(2, 3, '', ',');
                            } else {
                                if (!!data[0])
                                    displayTotal = data[0].total.replace('R$ ', '').replace('R$', '');
                                else
                                    displayTotal = "0,00"
                            }

                            if (displayTotal.indexOf(',') < 0) {
                                displayTotal += ',00';
                            }

                            $(tfoot).find('th').eq(0).html("Total: R$" + displayTotal);
                            $('input#totalProdutos').val(displayTotal);
                            fnChangeFrete();
                        }
                    });
                } else {
                    fly01.toast(response.message, 'error');
                }
            },
            error: function (jXHR, textStatus, errorThrown) {
                fly01.toast(errorThrown, 'error');
            }
        });
    }
</script>