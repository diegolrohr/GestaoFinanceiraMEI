<script>
    function fnAtualizaCertificado(input) {
        if ($("#senha").val() == "") {
            $$$.toast('Informe a senha do certificado.', 'error');
            return;
        }
        $("#cardCertificado").loading("start");
        if (!window.FileReader) return; // Browser is not compatible
        if ($("#certificado")[0].files[0] == null) {
            $("#cardCertificado").loading("stop");
            $$$.toast('Selecione um arquivo de certificado e informe a senha para atualizar', 'error');
            return;
        }
        var reader = new FileReader();
        // Read file into memory as UTF-8
        reader.readAsDataURL($("#certificado")[0].files[0]);
        // Handle errors load
        reader.onload = processData;
        reader.onerror = errorHandler;
    }

    function processData(event) {
        var pfx = event.target.result;
        var senha = $("#senha").val();
        var id = $("#id").val();

        $.ajax({
            type: "POST",
            url: "@Url.Action("ValidaDadosEmpresa", "EmpresaAtualizaIE")",
            data: {},
            success: function (response) {
                if (response.success) {
                    $.ajax({
                        type: "POST",
                        url: "@Url.Action("ImportaCertificado", "CertificadoDigital")",
                        data: {
                        id: id,
                        conteudo: pfx,
                        senha: senha
                        },
                    success: function (response) {
                        if (response.success) {
                            fnGetStatusCertificado();
                            $$$.fn.updateTextFields();
                            $$$.toast(response.message, "success");
                        }
                        else {
                            fnGetStatusCertificado();
                            $$$.fn.submitErrorHandler(null, response.message);
                        }
                    }
                });
                }
                else {
                    $("#cardCertificado").loading("stop");
                    var url = "@Url.Action("ModalAtualizaIE", "EmpresaAtualizaIE")";
                    $$$.modal(url);
                }
                }
        });
    }

    function errorHandler(evt) {
        if (evt.target.error.name == "NotReadableError") {
            alert("Não foi possível ler o arquivo!");
        }
    }
</script>