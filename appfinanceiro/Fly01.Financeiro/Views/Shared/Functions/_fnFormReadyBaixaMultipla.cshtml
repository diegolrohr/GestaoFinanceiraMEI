<script>
    @Html.Partial("Functions/_fnMain");

    var rows_selected = [];
    var qtLimiteBaixaMultipla = 50;

    function setupGridSelectEvents() {
        fly01._.dtContasExistentes.on("select", function (e, dt, type, indexes) {
            if (type !== undefined) {
                var valorAcumulado = parseFloat(getValorSomaSelecionados());
                var rowsCount = 0;

                indexes.forEach(function (element, index, array) {
                    var rowData = fly01._.dtContasExistentes.row(element).data();
                    $('#btnDeselectAll').removeAttr('disabled');

                    var index = $.inArray(rowData.id, rows_selected);
                    if (index == -1) {//se não tem, add, mas se ficar clicando inúmeras vezes em selecionar tudo, tem este array auxiliar
                        rows_selected.push(rowData.id);
                        var valorSaldo = parseFloat(rowData.saldo.replace("R$ ", "").replace("R$", "").replace(".", "").replace(",", "."));
                        valorAcumulado += valorSaldo;
                        rowsCount++;
                    }
                });

                fnAtualizaCountSelecionados(rowsCount);
                $('input#somaValoresSelecionados').val(valorAcumulado.toFixed(2));
                $('input#contasFinanceirasGuids').val(fly01._.dtContasExistentes.selected);
            }
        }).on('deselect', function (e, dt, type, indexes) {
            if (type !== undefined) {
                var valorAcumulado = parseFloat(getValorSomaSelecionados());
                var rowsCount = 0;

                indexes.forEach(function (element, index, array) {
                    var rowData = fly01._.dtContasExistentes.row(element).data();

                    var index = $.inArray(rowData.id, rows_selected);
                    if (index !== -1) {//se achou remove
                        rows_selected.splice(index, 1);
                        var valorSaldo = parseFloat(rowData.saldo.replace("R$ ", "").replace("R$", "").replace(".", "").replace(",", "."));
                        valorAcumulado -= valorSaldo;
                        rowsCount++;
                    }
                });

                if (valorAcumulado < 0) {
                    valorAcumulado = 0.0;
                }
                fnAtualizaCountSelecionados(-rowsCount);
                $('input#somaValoresSelecionados').val(valorAcumulado.toFixed(2));
                $('input#contasFinanceirasGuids').val(fly01._.dtContasExistentes.selected);
            }
        });
    }

    function getValorSomaSelecionados() {
        var somaValores = $('#somaValoresSelecionados').val().replace("R$", "").replace("R$ ", "").replace(".", "").replace(",", ".");
        return parseFloat(somaValores).toFixed(2);
    }

    function getCountAtual() {
        return parseInt($('input#countContasSelecionadas').val());
    }

    function fnAtualizaCountSelecionados(count) {
        var countAtual = getCountAtual();
        countAtual = countAtual + (parseInt(count));
        $('input#countContasSelecionadas').val(countAtual);

        fly01.fn.updateTextFields();
        $('input#countContasSelecionadas').css('color', '');
        $('#save').attr('disabled', 'disabled');

        if (countAtual > 0 && countAtual <= qtLimiteBaixaMultipla) {
            $('input#countContasSelecionadas').css('color', 'green');
            $('#save').removeAttr('disabled');
            if (countAtual == qtLimiteBaixaMultipla) {
                $('#btnSelectAll').attr('disabled', 'disabled');
            }
            else {
                $('#btnSelectAll').removeAttr('disabled');
            }
        }
        else if (countAtual <= 0) {
            $('#countContasSelecionadas').css('color', 'red');
            $('#save').attr('disabled', 'disabled');
            $('#btnDeselectAll').attr('disabled', 'disabled');
            $('#btnSelectAll').removeAttr('disabled');
        }
        else {
            $('#countContasSelecionadas').css('color', 'red');
            $('#save').attr('disabled', 'disabled');
            $('#btnSelectAll').attr('disabled', 'disabled');
            fly01.toast('Permitido selecionar até ' + qtLimiteBaixaMultipla + ' contas.', "error")
        }
    }

    function fnFormReadyBaixaMultipla() {
        $('#Field').hide();
        $('#save').attr('disabled', 'disabled');
        $('#btnDeselectAll').attr('disabled', 'disabled');
        setupGridSelectEvents();
        rows_selected = [];
    }
</script>