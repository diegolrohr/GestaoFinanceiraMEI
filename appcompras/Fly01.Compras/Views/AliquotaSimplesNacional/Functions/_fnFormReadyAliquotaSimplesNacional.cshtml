<script>
    @Html.Partial("Functions/_fnMain");

    function fnFormReadyAliquotaSimplesNacional() {
        $$$.fn.updateTextFields();

        fnBindOverrideSubmit();
    }

    function fnBindOverrideSubmit() {
        $("form#fly01mdlfrmAliquotaSimplesNacional").off("submit");
        $("form#fly01mdlfrmAliquotaSimplesNacional").on("submit", function (e) {
            e.preventDefault();
            if (!$(this).valid()) return false;

            //if ($("input#enviarEmailContador").prop("checked") == true && !checkEmail($("form#fly01mdlfrmAliquotaSimplesNacional input#emailContador").val())) {
            //    $$$.toast("E-mail do contador inválido", "error");
            //    return false;
            //}

            $$$.loading.start();
            fly01mdlfrmAliquotaSimplesNacional
            var dataEmail =
            {
                simplesNacional: $("form#fly01mdlfrmAliquotaSimplesNacional input#simplesNacional").val(),
                impostoRenda: $("form#fly01mdlfrmAliquotaSimplesNacional input#impostoRenda").val(),
                csll: $("form#fly01mdlfrmAliquotaSimplesNacional input#csll").val(),
                cofins: $("form#fly01mdlfrmAliquotaSimplesNacional input#cofins").val(),
                pisPasep: $("form#fly01mdlfrmAliquotaSimplesNacional input#pisPasep").val(),
                iss: $("form#fly01mdlfrmAliquotaSimplesNacional input#iss").val(),
                email: $("form#fly01mdlfrmAliquotaSimplesNacional input#emailContador").val(),
                fcp: "0",
                inss: "0",
            };

            if ($('input#isOnCadastroParametros').val() == "True") {
                $("form#fly01frm input#aliquotaSimplesNacional").val(dataEmail.simplesNacional);
                $("form#fly01frm input#aliquotaImpostoRenda").val(dataEmail.impostoRenda);
                $("form#fly01frm input#aliquotaCSLL").val(dataEmail.csll);
                $("form#fly01frm input#aliquotaCOFINS").val(dataEmail.cofins);
                $("form#fly01frm input#aliquotaPISPASEP").val(dataEmail.pisPasep);
                $("form#fly01frm input#aliquotaISS").val(dataEmail.iss);
                $$$._.fly01mdlfrmAliquotaSimplesNacional.close();
                $$$.fn.updateTextFields();
                $$$.loading.stop();
            }
            else {
                enableFields();
                var jsonData = $(this).serializeObject();
                jsonData.enviarEmailContador = $("input#enviarEmailContador").prop("checked") == true;
                disableFields();

                url = '@Url.Action("Create", "AliquotaSimplesNacional")';
                debugger;
                $.ajax({
                    contentType: 'application/json',
                    dataType: 'json',
                    type: 'POST',
                    url: url,
                    data: JSON.stringify(jsonData),
                    success: function success(data) {
                        if (data.success) {
                            debugger;
                            var strMsg = "Cadastrado com sucesso.";
                            if (data.message !== "") strMsg = data.message;
                            $$$.toast(strMsg, "success");
                            $$$.loading.stop();
                            $$$._.fly01mdlfrmAliquotaSimplesNacional.close();
                            if (jsonData.enviarEmailContador = "true") {
                                enviaEmailContador(dataEmail);
                            }
                        } else {
                            $$$.loading.stop();
                            $$$.fn.submitErrorHandler(null, data.message);
                        }
                    },
                    error: function error(jXHR, textStatus) {
                        $$$.toast(textStatus, "error");
                        $$$.loading.stop();
                    }
                });
            }
        });
    }

    function enableFields() {
        $("form#fly01mdlfrmAliquotaSimplesNacional input#simplesNacional").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#impostoRenda").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#csll").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#cofins").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#pisPasep").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#iss").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#emailContador").removeAttr('disabled');
    }

    function disableFields() {
        $("form#fly01mdlfrmAliquotaSimplesNacional input#simplesNacional").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#impostoRenda").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#csll").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#cofins").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#pisPasep").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#iss").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#emailContador").attr('disabled', 'disabled');
    }

    function enviaEmailContador(dataEmail) {
        debugger;
        $$$.loading.start();
        $.ajax({
            url: '@Url.Action("EnviaEmailContador", "ParametroTributario")',
            data: dataEmail,
            type: "POST",
            success: function (data) {
                $$$.loading.stop();
                if (data.success) {
                    $$$.toast("E-mail enviado com sucesso.", "success");
                } else {
                    $$$.fn.submitErrorHandler(null, data.message);
                }
                $$$.loading.stop();
            },
            error: function (jqxhr, textStatus, error) {
                var err = 'Ocorreu um erro ao enviar o e-mail: ' + textStatus + ", " + error;
                $$$.toast(err, "error");
                $$$.loading.stop();
            }
        });
    }
</script>