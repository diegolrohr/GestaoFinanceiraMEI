<script>
    @Html.Partial("Functions/_fnMain");

    function fnFormReadyAliquotaSimplesNacional() {
        $$$.fn.updateTextFields();
        if ($('input#isOnCadastroParametros').val() == "False") {
            $("input#enviarEmailContador").prop("checked", true);
        }
        fnSetInformacoes();
        $('.collapsible').collapsible();
        fnBindOverrideSubmit();
    }

    function fnSetInformacoes() {
        var textAliquotas = [
            createElem("span", null, "O Simples Nacional é composto por 5 anexos "),
            createElem("a", { "target": "_blank", "href": "http://www.planalto.gov.br/ccivil_03/leis/LCP/Lcp155.htm" }, "(Lei Complementar 155)."),
            createElem("br"),
            createElem("span", null, "Cada anexo possui faixas de alíquotas diferentes "),
            createElem("a", { "target": "_blank", "href": "http://www.planalto.gov.br/ccivil_03/leis/LCP/Lcp123.htm" }, "(Lei Complementar 123)."),
            createElem("br"),
            createElem("span", null, "O sistema irá sugerir as alíquotas de acordo com as opções escolhidas."),
            createElem("br"),
            createElem("span", null, "Utilize a opção de enviar um e-mail com as alíquotas configuradas, para o seu contador."),
            createElem("br"),
            createElem("span", null, "Importante! Consulte sempre o seu contador para auxiliar nas configurações de alíquotas e evitar problemas fiscais."),
            createElem("br"),
            createElem("span", null, "Peça também para seu contador checar se o seu CNAE se enquadra ao regime tributário Simples Nacional."),
            createElem("br"),
        ];

        $("#infoAliquotasField")[0].innerText = "";
        $("#infoAliquotasField").append(createElem("ul",
            { "class": "collapsible", "data-collapsible": "accordion" },
            createElem("li", null, [
                createElem("div", { "class": "collapsible-header" }, createElem("h6", { "class": "orange-text light" }, "Informações Importantes!")),
                createElem("div", { "class": "collapsible-body" }, textAliquotas)
            ])
        ));
    }

    function fnBindOverrideSubmit() {
        $("form#fly01mdlfrmAliquotaSimplesNacional").off("submit");
        $("form#fly01mdlfrmAliquotaSimplesNacional").on("submit", function (e) {
            e.preventDefault();
            if (!$(this).valid()) return false;
            if ($("form#fly01mdlfrmAliquotaSimplesNacional #tipoEnquadramentoEmpresaDescricao").val() == "") {
                $$$.toast("Informe o enquadramento da Empresa", "error");
                return false;
            }

            $$$.loading.start();
            fly01mdlfrmAliquotaSimplesNacional
            var dataEmail =
            {
                simplesNacional: $("form#fly01mdlfrmAliquotaSimplesNacional input#simplesNacional").val(),
                impostoRenda: $("form#fly01mdlfrmAliquotaSimplesNacional input#impostoRenda").val(),
                csll: $("form#fly01mdlfrmAliquotaSimplesNacional input#csll").val(),
                cofins: $("form#fly01mdlfrmAliquotaSimplesNacional input#cofins").val(),
                pisPasep: $("form#fly01mdlfrmAliquotaSimplesNacional input#pisPasep").val(),
                iss: $("form#fly01mdlfrmAliquotaSimplesNacional input#iss").val(),
                email: $("form#fly01mdlfrmAliquotaSimplesNacional input#emailContador").val(),
                fcp: "0",
                inss: "0",
            };

            //Atualiza dados da tela
            if ($('input#isOnCadastroParametros').val() == "True") {
                $("form#fly01frm input#aliquotaSimplesNacional").val(dataEmail.simplesNacional);
                $("form#fly01frm input#aliquotaImpostoRenda").val(dataEmail.impostoRenda);
                $("form#fly01frm input#aliquotaCSLL").val(dataEmail.csll);
                $("form#fly01frm input#aliquotaCOFINS").val(dataEmail.cofins);
                $("form#fly01frm input#aliquotaPISPASEP").val(dataEmail.pisPasep);
                $("form#fly01frm input#aliquotaISS").val(dataEmail.iss);
                $$$._.fly01mdlfrmAliquotaSimplesNacional.close();
                $$$.fn.updateTextFields();
                $$$.loading.stop();
                return true;
            }
            else {//ou salva novo parâmetro na home
                $.ajax({
                    url: '@Url.Action("ValidaDadosEmpresa", "ParametroTributario")',
                    type: "POST",
                    data: {
                    },
                    success: function (response) {
                        if (response.success) {
                            enableFields();
                            var jsonData = $("form#fly01mdlfrmAliquotaSimplesNacional").serializeObject();
                            jsonData.enviarEmailContador = $("input#enviarEmailContador").prop("checked") == true;
                            disableFields();

                            url = '@Url.Action("Create", "AliquotaSimplesNacional")';
                            $.ajax({
                                contentType: 'application/json',
                                dataType: 'json',
                                type: 'POST',
                                url: url,
                                data: JSON.stringify(jsonData),
                                success: function success(data) {
                                    if (data.success) {
                                        var strMsg = "Cadastrado com sucesso.";
                                        if (data.message !== "") strMsg = data.message;
                                        $$$.toast(strMsg, "success");
                                        $$$.loading.stop();
                                        $$$._.fly01mdlfrmAliquotaSimplesNacional.close();
                                        if (jsonData.enviarEmailContador == true) {
                                            enviaEmailContador(dataEmail);
                                        }
                                    } else {
                                        $$$.loading.stop();
                                        $$$.fn.submitErrorHandler(null, data.message);
                                    }
                                },
                                error: function error(jXHR, textStatus) {
                                    $$$.toast(textStatus, "error");
                                    $$$.loading.stop();
                                }
                            });
                        }
                        else {
                            $$$.loading.stop();
                            var url = "@Url.Action("ModalAtualizaIE", "AliquotaSimplesNacional")";
                            $$$.modal(url);
                        }
                    },
                });
            }
        });
    }

    function enableFields() {
        $("form#fly01mdlfrmAliquotaSimplesNacional input#simplesNacional").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#impostoRenda").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#csll").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#cofins").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#pisPasep").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#iss").removeAttr('disabled');
    }

    function disableFields() {
        $("form#fly01mdlfrmAliquotaSimplesNacional input#simplesNacional").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#impostoRenda").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#csll").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#cofins").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#pisPasep").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#iss").attr('disabled', 'disabled');
    }

    function enviaEmailContador(dataEmail) {
        $$$.loading.start();
        $.ajax({
            url: '@Url.Action("EnviaEmailContador", "ParametroTributario")',
            data: dataEmail,
            type: "POST",
            success: function (data) {
                $$$.loading.stop();
                if (data.success) {
                    $$$.toast("E-mail enviado com sucesso.", "success");
                } else {
                    $$$.fn.submitErrorHandler(null, data.message);
                }
                $$$.loading.stop();
            },
            error: function (jqxhr, textStatus, error) {
                var err = 'Ocorreu um erro ao enviar o e-mail: ' + textStatus + ", " + error;
                $$$.toast(err, "error");
                $$$.loading.stop();
            }
        });
    }
</script>