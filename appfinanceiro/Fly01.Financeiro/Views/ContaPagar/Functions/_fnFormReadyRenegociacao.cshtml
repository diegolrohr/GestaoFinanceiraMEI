<script>
    var rows_selected = [];

    function limpaCampos() {
        rows_selected = [];
        $('#contasFinanceirasIds').val("");
        $('#valorFinal').val(0);
        $('#valorAcumulado').val(0);
        $('#valorDiferenca').val(0);
    }

    function ocultaCampos() {
        $('#selecaoTitulosLabelField').hide();
        $('#datatableSelecaoTitulos_wrapper').hide();
        $('#informacoesRenegociacaoLabel').hide();
        $('#motivoField').hide();
        $('#valorAcumuladoField').hide();
        $('#tipoRenegociacaoValorDiferencaField').hide();
        $('#tipoRenegociacaoCalculoField').hide();
        $('#valorDiferencaField').hide();
        $('#valorFinalField').hide();
        $('#informacoesNovoTituloLabelField').hide();
        $('#descricaoRenegociacaoField').hide();
        $('#dataEmissaoField').hide();
        $('#dtVencimentoField').hide();
        $('#formaPagamentoIdField').hide();
        $('#condicaoParcelamentoIdField').hide();
        $('#categoriaIdField').hide();
    }
    function exibeCampos() {
        $('#selecaoTitulosLabelField').show();
        $('#datatableSelecaoTitulos_wrapper').show();
        $('#informacoesRenegociacaoLabel').show();
        $('#motivoField').show();
        $('#valorAcumuladoField').show();
        $('#tipoRenegociacaoValorDiferencaField').show();
        $('#tipoRenegociacaoCalculoField').show();
        $('#valorDiferencaField').show();
        $('#valorFinalField').show();
        $('#informacoesNovoTituloLabelField').show();
        $('#descricaoRenegociacaoField').show();
        $('#dataEmissaoField').show();
        $('#dtVencimentoField').show();
        $('#formaPagamentoIdField').show();
        $('#condicaoParcelamentoIdField').show();
        $('#categoriaIdField').show();
    }

    function renegociacaoCalculaValorFinal() {
        var valorAcumulado = parseFloat($('#valorAcumulado').val().replace("R$ ", "").replace(".", "").replace(",", "."));
        var valorDiferenca = parseFloat($('#valorDiferenca').val().replace("R$ ", "").replace(".", "").replace(",", "."));
        var valorDiferencaCalculado = 0.00;
        var valorFinal = 0.00;

        if (valorAcumulado > 0 && valorDiferenca >= 0) {
            if ($('select#tipoRenegociacaoCalculo').val() == "Valor") {
                valorDiferencaCalculado = valorDiferenca;
            }
            else if ($('select#tipoRenegociacaoCalculo').val() == "Percentual") {
                valorDiferencaCalculado = (parseFloat(valorAcumulado * valorDiferenca) / 100.00);
            }

            if ($('select#tipoRenegociacaoValorDiferenca').val() == "Acrescimo") {
                valorFinal = parseFloat(valorAcumulado + valorDiferencaCalculado);
                if (valorFinal <= 0.0){ 
                    $$$.toast("Valor final deve ser superior a zero.", 'error');
                }
            }
            else if ($('select#tipoRenegociacaoValorDiferenca').val() == "Desconto") {
                valorFinal = parseFloat(valorAcumulado - valorDiferencaCalculado);
                if (valorFinal <= 0.0) {
                    $$$.toast("Valor final deve ser superior a zero.", 'error');
                }
            }
        }

        $('#valorFinal').val(valorFinal.toString().replace(",", "").replace(".", ","));
    }

    function fnFormReadyRenegociacao() {
        //$$$.fn.updateTextFields();
        $('#selecaoTitulosLabelField').hide();
        $('#datatableSelecaoTitulos_wrapper').hide();
        $('#Field').hide();
        $('#save').attr('disabled', 'disabled');
        ocultaCampos();
        limpaCampos();
        $('select#tipoRenegociacaoValorDiferenca').val("Acrescimo");
        $('select#tipoRenegociacaoCalculo').val("Valor");

        $$$._.datatableSelecaoTitulos.on('select', function (e, dt, type, indexes) {
            var valorAcumulado = parseFloat($('#valorAcumulado').val().replace("R$ ", "").replace(".", "").replace(",", "."));
            var rowData = $$$._.datatableSelecaoTitulos.rows(indexes).data().toArray();

            var index = $.inArray(rowData[0].id, rows_selected);
            if (index == -1) {//se não tem, add
                rows_selected.push(rowData[0].id);
                valorAcumulado += parseFloat(rowData[0].saldoSemFormatacao);

                fnAtualizaValorAcumulado(valorAcumulado);
            }

        }).on('deselect', function (e, dt, type, indexes) {
            var valorAcumulado = parseFloat($('#valorAcumulado').val().replace("R$ ", "").replace(".", "").replace(",", "."));
            var rowData = $$$._.datatableSelecaoTitulos.rows(indexes).data().toArray();
            var index = $.inArray(rowData[0].id, rows_selected);
            if (index !== -1) {//se achou remove
                rows_selected.splice(index, 1);
                valorAcumulado -= parseFloat(rowData[0].saldoSemFormatacao);

                fnAtualizaValorAcumulado(valorAcumulado);
            }
        });
    }
</script>