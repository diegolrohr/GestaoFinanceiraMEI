<script>
    @Html.Partial("Functions/_fnMain");

    var justSavePedidoToGoStepProdutos = false;
    var onCancelMustDeletePedido = false;

    function isCreate() {
        var id = $("form#fly01frm input#id").val();

        if (id.length == 0)
            return true;

        return false;
    }

    function calculaTotalPedido() {
        var valorFrete = 0;
        var tipoFrete = $('select#tipoFrete').val();
        var tipoVenda = $('#tipoVenda').val();
        var tipoNfeComplementar = $('#tipoNfeComplementar').val();

        var calculaFrete = (
                ((tipoFrete == "CIF" || tipoFrete == "Remetente") && tipoVenda == "Normal") ||
                ((tipoFrete == "FOB" || tipoFrete == "Destinatario") && tipoVenda == "Devolucao")
            );

        if (calculaFrete) {
            valorFrete = TryParseFloat(noComma($('input#valorFrete').val()));
        }

        var idPedido = $("form#fly01frm input#id").val();
        var idCliente = $("form#fly01frm input#clienteId").val();
        var geraNotaFiscal = $('input#geraNotaFiscal:checked').val() == "true";
        if (geraNotaFiscal && $$$._.dtOrdemVendaProdutos.data(0).length > 0) {
            $("#naturezaOperacaoField").show();
            $("input#naturezaOperacao").rules("add", { required: true });
            $('#mensagemPadraoNotaField').show();
        }
        else {
            $("#naturezaOperacaoField").hide();
            $("input#naturezaOperacao").rules("remove", "required");
            $('input#naturezaOperacao').removeClass("invalid")
            $('#mensagemPadraoNotaField').hide();
        }

        if (geraNotaFiscal && $$$._.dtOrdemVendaServicos.data(0).length > 0) {
            $("#informacoesCompletamentaresNFSField").show();
            $("input#informacoesCompletamentaresNFS").rules("add", { required: true });
            $('#informacoesCompletamentaresNFSField').show();
        }
        else {
            $("#informacoesCompletamentaresNFSField").hide();
            $("input#informacoesCompletamentaresNFS").rules("remove", "required");
            $('input#informacoesCompletamentaresNFS').removeClass("invalid")
            $('#informacoesCompletamentaresNFSField').hide();
        }

        $$$.loading.start();

        $.ajax({
            url: '@Url.Action("TotalOrdemVenda", "OrdemVenda")',
            type: "GET",
            data: { id: idPedido, clienteId: idCliente, geraNotaFiscal: geraNotaFiscal, tipoNfeComplementar: tipoNfeComplementar, tipoFrete: tipoFrete, valorFrete: valorFrete }
        })
        .done(function (data) {
            if (data.success) {
                $('input#totalProdutos').val(data.total.TotalProdutos.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosProdutos').val(data.total.TotalImpostosProdutos.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosProdutosNaoAgrega').val(data.total.TotalImpostosProdutosNaoAgrega.formatMoneyMask(2, 3, '', ','));
                $('input#totalServicos').val(data.total.TotalServicos.formatMoneyMask(2, 3, '', ','));
                $('input#totalRetencoesServicos').val(data.total.TotalRetencoesServicos.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosServicosNaoAgrega').val(data.total.TotalImpostosServicosNaoAgrega.formatMoneyMask(2, 3, '', ','));
                $('input#totalFrete').val(data.total.ValorFrete.formatMoneyMask(2, 3, '', ','));
                $('input#totalOrdemVenda').val(data.total.Total.formatMoneyMask(2, 3, '', ','));
                $$$.fn.updateTextFields();
            }
            else {
                $('input#totalProdutos').val(0.0.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosProdutos').val(0.0.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosProdutosNaoAgrega').val(0.0.formatMoneyMask(2, 3, '', ','));
                $('input#totalServicos').val(0.0.formatMoneyMask(2, 3, '', ','));
                $('input#totalRetencoesServicos').val(0.0.formatMoneyMask(2, 3, '', ','));
                $('input#totalImpostosServicosNaoAgrega').val(0.0.formatMoneyMask(2, 3, '', ','));
                $('input#totalFrete').val(0.0.formatMoneyMask(2, 3, '', ','));
                $('input#totalOrdemVenda').val(0.0.formatMoneyMask(2, 3, '', ','));
                $$$.fn.submitErrorHandler(null, data.message);
            }
            $$$.loading.stop();
        })
        .fail(function (jqxhr, textStatus, error) {
            var err = 'Ocorreu um erro na requisição: ' + textStatus + ", " + error;
            $$$.toast(err, "error");
            $$$.loading.stop();
        });
    }

    function getInformacoesComplementares() {
        $$$.loading.start();
        $.ajax({
            url: '@Url.Action("GetInformacoesComplementares", "OrdemVenda")',
            type: "GET",
            data: {}
        })
        .done(function (data) {
            if (data.success) {
                $('#mensagemPadraoNota').val(data.infcomp);
                $$$.fn.updateTextFields("fly01frm");
                $$$.loading.stop();
            }
            else {
                $$$.fn.submitErrorHandler(null, data.message);
                $$$.loading.stop();
            }
        })
        .fail(function (jqxhr, textStatus, error) {
            var err = 'Ocorreu um erro na requisição: ' + textStatus + ", " + error;
            $$$.toast(err, "error");
            $$$.loading.stop();
        });
    }

    function disableStepFinalidade() {
        //para não ficar trocando o chaveSefaz

        if (!$("form#fly01frm").valid()) return false;
        $('input#chaveNFeReferenciada').attr('disabled', 'disabled');
        $('#nFeRefComplementarIsDevolucao').attr('disabled', 'disabled');
        $("#tipoNfeComplementarField").hide();

        if ($("#categoriaDescricao").data("url-post"))
            $("#categoriaDescricao").data("url-post", "@Url.Action("NovaCategoria")?tipo=" + $("#tipoCarteira").val());

        var tipoVendaVal = $('#tipoVenda').val();
        var tipoNfeComplementarVal = $('#tipoNfeComplementar').val();

        if (tipoVendaVal == "Devolucao" || tipoVendaVal == "Complementar") {
            $("#fly01btngrpFinalidade #btnNormal").hide();
            $('#stepServicos').hide();
            $("#chaveNFeReferenciadaField").show();
        }

        if (tipoVendaVal == "Complementar") {
            $("#tipoNfeComplementarField").show();
            $("#nFeRefComplementarIsDevolucaoField").show();
            $('#stepTransporte').hide();
            $("#fly01btngrpFinalidade #btnDevolucao").hide();
            if (tipoNfeComplementarVal == "ComplIcms") {
                $('#stepFinanceiro').hide();
                $("input#geraFinanceiro").prop("checked", false);
            }
            if (tipoNfeComplementarVal != "ComplPrecoQtd") {
                $("input#movimentaEstoque").prop("checked", false);
                $("#movimentaEstoqueField").hide();
            }
        }
        else if (tipoVendaVal == "Normal") {
            $("#fly01btngrpFinalidade #btnDevolucao").hide();
            $("#fly01btngrpFinalidade #btnComplementar").hide();
            $("#tipoNfeComplementarField").hide();
            $("#nFeRefComplementarIsDevolucaoField").hide();
        }
        else if (tipoVendaVal == "Devolucao") {
            $("#fly01btngrpFinalidade #btnComplementar").hide();
            $("#nFeRefComplementarIsDevolucaoField").hide();
        }
    }

    function fnBindStepsWizard() {
        function savePedido() {
            if (isCreate() && ($("li#stepCadastro").hasClass("active"))) {
                justSavePedidoToGoStepProdutos = true;
                return $("form#fly01frm").submit();
            }
        }
        $('li#stepProdutos div.step-title').click(function () {
            savePedido();
        });
        $('#stepCadastro > div.step-content > div.step-actions > button.btn.next-step').click(function () {
            savePedido();
        });

        $('li#stepCadastro div.step-title').click(function () {
            disableStepFinalidade();
            fnChangeFrete();
        });
        $('#stepFinalidade > div.step-content > div.step-actions > button.btn.next-step').click(function () {
            disableStepFinalidade();
            fnChangeFrete();
        });
    }

    function fnBindOverrideSubmit() {
        $("form#fly01frm").off("submit");
        $("form#fly01frm").on("submit", function (e) {
            e.preventDefault();
            if (!$(this).valid()) return false;

            $$$.loading.start();

            $('input#numero').removeAttr('disabled');
            $('input#chaveNFeReferenciada').removeAttr('disabled');
            $('select#tipoNfeComplementar').removeAttr('disabled');
            $('select#tipoNfeComplementar').material_select();

            var jsonData = $(this).serializeObject();
            if ($('input#finalizarPedido:checked').val() == "true") {
                jsonData.status = "Finalizado";
            }

            $('input#numero').attr('disabled', 'disabled');
            $('input#orcamentoOrigemNumero').attr('disabled', 'disabled');
            $('select#tipoNfeComplementar').attr('disabled', 'disabled');
            $('select#tipoNfeComplementar').material_select();
            $$$.fn.updateTextFields();

            var url;
            if (isCreate()) {
                url = '@Url.Action("Create", "Pedido")';
            }
            else {
                url = '@Url.Action("Edit", "Pedido")';
            }

            $.ajax({
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                url: url,
                data: JSON.stringify({ 'entityVM': jsonData }),
                success: function success(data) {
                    if (data.success) {
                        $$$.loading.stop();

                        var strMsg = "Cadastrado com sucesso.";
                        if (data.message !== "" && !onCancelMustDeletePedido) strMsg = data.message;
                        //fica na página ou volta pra lista
                        if (justSavePedidoToGoStepProdutos) {
                            justSavePedidoToGoStepProdutos = false;
                            onCancelMustDeletePedido = true;
                            $("form#fly01frm input#id").val(data.id);
                            $("form#fly01frm input#numero").val(data.numero);

                            $$$._.dtOrdemVendaProdutos.refresh();
                            $$$._.dtOrdemVendaServicos.refresh();
                            var url = window.location.href.replace('/Create', '/Edit/' + data.id);
                            window.history.pushState({}, document.title, url);
                            $("form#fly01frm").data("action", "@Url.Action("Edit", "Pedido")");

                            if (jsonData.tipoVenda == "Devolucao" || jsonData.tipoVenda == "Complementar") {
                                //preencher os campos
                                $("div#clienteIdField").show();
                                $$$._.fly01frm.refresh(data.id);
                                $('li#stepProdutos div.step-title').click();
                            }
                            getInformacoesComplementares();

                            return true;
                        }
                        else {
                            $$$.toast(strMsg, "success");
                            $$$.go("@Url.Action("List","OrdemVenda")");
                        }
                    } else {
                        if (justSavePedidoToGoStepProdutos) {
                            $('#stepProdutos > div.step-content > div.step-actions > button.btn.previous-step').click();
                        }
                        $$$.loading.stop();
                        $("div#clienteIdField").show();
                        $$$.fn.submitErrorHandler(null, data.message);
                    }
                },
                error: function error(jXHR, textStatus) {
                    $$$.toast(textStatus, "error");
                    $$$.loading.stop();
                }
            });
        });
    }

    function fnSetInformacoes() {
        $("#infoEstoqueNegativoField").text('O estoque não pode ficar negativo, portanto abaixo é exibido a relação dos produtos que ficarão com o estoque faltante. Marque a opção para ajustar automáticamente a quantidade negativa ou realize os ajustes '
            + 'pelo aplicativo Bemacash Estoque. Ao marcar a opção Ajustar Negativo, serão criadas movimentações para que o saldo do produto fique com quantidade zerada.');
        $("#infoEstoqueNegativoField").css("white-space", "normal");
    }

    function EstoqueNegativoETotal() {
        $$$._.dtProdutosEstoqueNegativo.refresh();
        calculaTotalPedido();
    }

    function fnTipoVendaClick() {
        if ($('input#tipoVenda').val() == "Normal") {
            $('#btnNormal').click();
        }
        else if ($('input#tipoVenda').val() == "Devolucao") {
            $('#btnDevolucao').click();
        } else {
            $('#btnComplementar').click();
        }
    }

    function fnValidarCamposDeProdutos() {
        if ($$$._.dtOrdemVendaProdutos.data(0).length == 0) {
            $('#movimentaEstoque').prop('checked', false);
            $('#movimentaEstoqueField').hide();
        } else {
            $('#movimentaEstoqueField').show();
        }
    }

    function fnFormReadyPedido() {
        fnIsNovoPedido();
        fnClickComplementarIsDevolucao();
        $("#naturezaOperacaoField").hide();
        $("#chaveNFeReferenciadaField").hide();
        $$$.fn.updateActiveMenu("/OrdemVenda/List");

        if (isCreate()) {
            fnTipoVendaClick();
            var today = new Date();
            $("input#geraFinanceiro").prop("checked", true);
            $("input#movimentaEstoque").prop("checked", true);
            $("input#geraNotaFiscal").prop("checked", true);
            $$$._.data.set(today);
            $$$._.dataVencimento.set(today);
            $$$.fn.updateTextFields();
            fnBindStepsWizard();
        }
        else {
            fnTipoVendaClick();
            $('select#tipoNfeComplementar').attr('disabled', 'disabled');
            $('select#tipoNfeComplementar').material_select();

            disableStepFinalidade();
            if (!onCancelMustDeletePedido) { $('li#stepCadastro div.step-title').click(); }
            $$$._.dtOrdemVendaProdutos.refresh();
            $$$._.dtOrdemVendaServicos.refresh();
        }

        fnBindOverrideSubmit();
        fnValidaCamposGeraFinanceiro();
        fnChangeFrete();
        fnSetInformacoes();

        $('li#stepFinalizar div.step-title').click(function () {
            fnValidarCamposDeProdutos();
            if (!isCreate() && $("form#fly01frm").valid()) {
                EstoqueNegativoETotal();
            }
        });
        $('#stepTransporte > div.step-content > div.step-actions > button.btn.next-step').click(function () {
            fnValidarCamposDeProdutos();
            if (!isCreate() && $("form#fly01frm").valid()) {
                EstoqueNegativoETotal();
            }
        });

        $('#stepFinanceiro > div.step-content > div.step-actions > button.btn.next-step').click(function () {
            fnValidarCamposDeProdutos();
            if (!isCreate() && $("form#fly01frm").valid() && $('input#tipoVenda').val() == "Complementar") {
                EstoqueNegativoETotal();
            }
        });

        $('#stepProdutos > div.step-content > div.step-actions > button.btn.next-step').click(function () {
            fnValidarCamposDeProdutos();
            if (!isCreate() && $("form#fly01frm").valid() && $('input#tipoVenda').val() == "Complementar" && $('#tipoNfeComplementar').val() == "ComplIcms") {
                EstoqueNegativoETotal();
            }
        });
    }

    $("#stepFinanceiro .step-actions button.next-step, #stepTransporte:not(.active) .step-title, #stepFinalizar .step-actions button.previous-step").on("click", () => {
        if ($("#tipoFreteField .select-dropdown").val() == "Sem frete")
            fnDisableInput();
    });

    function fnIsNovoPedido() {
        if ($('#id').val() == "" || $('#id').val() == undefined) {
            $('#tipoFreteField select#tipoFrete').val("SemFrete")
            $("#tipoFreteField .select-dropdown").val("Sem frete");
        }
    }
</script>