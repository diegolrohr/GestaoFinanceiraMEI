<script>
    @Html.Partial("Functions/_fnImprimir");

    var serialize = function (obj, prefix) {
        var str = [],
            p;
        for (p in obj) {
            if (obj.hasOwnProperty(p)) {
                var k = prefix ? prefix + "[" + p + "]" : p,
                    v = obj[p];
                str.push((v !== null && typeof v === "object") ?
                    serialize(v, k) :
                    encodeURIComponent(k) + "=" + encodeURIComponent(v));
            }
        }
        return str.join("&");
    }

    function validateDate(id) {
        var RegExPattern = /^(0[1-9]|1[0-9]|2[0-9]|3[0-1])\/(0[1-9]|1[0-2])\/([0-9]{4})$/;

        if (!((id.match(RegExPattern)) && (id !=='')))
            return true;
        else
            return false;
    }

    function GetListParams() {
        var ListParams = [];
        if ($("#descricao").val() !== "") {
            ListParams.push({
                key: "descricao",
                value: $("#descricao").val()
            });
        };

        if ($("#descricaoParcela").val() !== "") {
            ListParams.push({
                key: "descricaoParcela",
                value: $("#descricaoParcela").val()
            });
        };

        if ($("#pessoa_nome").val() !== "") {
            ListParams.push({
                key: "pessoa/nome",
                value: $("#pessoa_nome").val()
            });
        };

        return ListParams;
    };

    function fnImprimirListContas() {
        var ListParams = GetListParams();
        var queryStringOdata = "";
        
        let  dataInicial = $("#dataInicial").val();
        let dataFinal = $("#dataFinal").val();

        var dateParam = $("#dataVencimento").val().split("/").reverse().join("/");
        var newDate = dateParam.replace("/", "-").replace("/", "-");

        for (var list in ListParams) {
            queryStringOdata += "contains(" + ListParams[list].key + ", " + "'" + ListParams[list].value + "'" + ")" + (ListParams[list] !==ListParams[ListParams.length - 1] ? " and " : "");
        }

        if (validateDate($("#dataVencimento").val()) && $("#dataVencimento").val() !== "") {
            $$$.toast('Data inválida', 'error');
        }
        else {
            if (dataInicial === "" && dataFinal === "") {
                var url = "@Url.Action("ImprimirListContas", "ContaPagar")?tipoStatus=" + $("#statusContaBancaria").val();
            } else {
                var url = "@Url.Action("ImprimirListContas", "ContaReceber")?queryStringOdata=" + queryStringOdata +
                    ((($("#dataInicial").val() !==undefined || dateParam !== "") ?
                        (dateParam !==undefined && dateParam !== "" ?
                            ((queryStringOdata !== "") ? " and" : "") + " dataVencimento eq " + newDate :
                            ((queryStringOdata !== "") ? " and" : "") + " dataVencimento le " + dataFinal + " and dataVencimento ge " + dataInicial): "") +
                    (($("#valorPrevisto").val() !== "" && $("#valorPrevisto").val() !=="0,00") ?
                        (($("#dataInicial").val() !==undefined || dateParam !== "" || queryStringOdata !== "" ) ?
                            " and valorPrevisto eq " + parseFloat($("#valorPrevisto").val().replace(",", ".")) : "valorPrevisto eq " + parseFloat($("#valorPrevisto").val().replace(",", "."))) : "") +
                    ($("#numero").val() !== "" ?
                        (($("#valorPrevisto").val() !== "" && $("#valorPrevisto").val() !=="0,00" || queryStringOdata !== "" || $("#dataInicial").val() !==undefined || dateParam !== "") ?
                            " and numero eq " + $("#numero").val() : " numero eq " + $("#numero").val()) : "") )+
                    "&tipoStatus=" + $("#statusContaBancaria").val();
            }

            if ($$$._.fly01dt.ajax.json().data.length > 0)
                fnImprimir(url);
            else
                $$$.toast('Não há dados para imprimir!', 'error');
        }
    }
</script>

