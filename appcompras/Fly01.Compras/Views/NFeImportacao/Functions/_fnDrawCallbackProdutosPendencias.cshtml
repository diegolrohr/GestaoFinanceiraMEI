<script>
    function fnDrawCallbackProdutosPendencias() {
        $('#dtProdutosPendencias_paginate').hide();
        //TODO: diego ver tooltip
        //$(document).tooltip();

        $("input.autocomplete").each((i, it) => {
            let that = $(it);
            let _ = $$$._;
            _[that.attr("id")] = $(it).autocomplete({
                delay: 200,
                minLength: 0,
                classes: {
                    "ui-autocomplete": "autocomplete-content dropdown-content"
                },
                source: (request, response) => {
                    $.ajax({
                        url: that.data("url"),
                        data: request,
                        success: function success(data) {                           
                            response(data);
                        }
                    });
                },
                change: (event, ui) => {
                    if (ui && ui.item) {
                        $(`#${that.attr("id")}`).val(ui.item.label);
                        $(`#${that.data("target")}`).val(ui.item.id);
                    }
                    else {
                        $(`#${that.attr("id")}`).val("");
                        $(`#${that.data("target")}`).val("");
                    }
                    return false;
                },
                select: (event, ui) => {
                    $(`#${that.attr("id")}`).val(ui.item.label);
                    $(`#${that.data("target")}`).val(ui.item.id);

                    $("#unidadeCadastro" + `${that.data("id")}`).val(ui.item.unidadeSigla);
                    if ($("#unidadeXml" + `${that.data("id")}`).val() != ui.item.unidadeSigla) {
                        $("#btnFatorconversao" + `${that.data("id")}`).show();
                    }
                    else {
                        //$("#btnFatorconversao" + `${that.data("id")}`).hide();
                        $("#fatorConversao" + `${that.data("id")}`).val(1.00);
                        $("#tipoFatorConversao" + `${that.data("id")}`).val("Multiplicar");
                    }

                    return false;
                },
                messages: { noResults: "", results() { } }
            }).autocomplete("instance");

            _[that.attr("id")]._renderItem = (ul, item) => {
                let searchData = $("#" + that.attr("id")).val();
                let level = (item.level || 0);
                let label = item.label;
                let detail = item.detail ? "<br><small>" + item.detail + "</small>" : "";

                if (searchData != "") {
                    const regex = new RegExp(`(${searchData.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&").split(" ").join("|")})`, "gi");
                    label = item.label.replace(regex, "<span class=\"highlight\">$1</span>");
                    detail = item.detail ? "<br><small>" + item.detail.replace(regex, "<span class=\"highlight\">$1</span>") + "</small>" : "";
                }

                return $("<li>").append(`<span class="lvl-${level}">${label}${detail}</span>`).appendTo(ul);
            };

            _[that.attr("id")]._renderItemData = (ul, item) => {
                return _[that.attr("id")]._renderItem(ul, item).data("ui-autocomplete-item", item);
            };

            _[that.attr("id")]._renderMenu = (ul, items) => {
                $.each(items, function (index, item) {
                    _[that.attr("id")]._renderItemData(ul, item);
                });
            };

            that.on("focus", function () {
                if (!($(it).prop("readonly") || $(it).prop("disabled")))
                    $(it).autocomplete("search", $(it).val());
            });
        });
    }
</script>