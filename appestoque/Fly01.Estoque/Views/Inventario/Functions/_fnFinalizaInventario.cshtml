<script>
    function fnFinalizaInventario(){
        var idRecord = $("input[type=hidden]#id").val();

        if (idRecord.length == 0) {
            fly01.toast("É necessário salvar o inventário antes de finaliza-lo", 'warning');
            return;
        }

        fly01._.dtInventarioItem.refresh();

        var dtData = fly01._.dtInventarioItem.data();

        if (!dtData || dtData.length == 0) {
            fly01.toast("Não é possivel salvar um inventário sem produtos.", 'warning');
            return;
        }

        fly01.modal.confirm("Confirmar Finalização", "Deseja realmente finalizar este inventário?", "fnFinalizaInventarioConfirmed(\"" + idRecord + "\")");
    }

    function fnFinalizaInventarioConfirmed(id) {
        var myForm = "form#fly01frmInventario"

        var that = $(myForm);

        var action = that.attr("action");

        var formData = that.serializeObject();

        formData.inventarioStatus = "Finalizado";

        $('body').removeClass('loaded');
        if (id) {
            $.ajax({
                type: "POST",
                url: action,
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(formData),
                success: function (data) {
                    $('body').addClass('loaded');
                    if (data.success) {
                        fly01.toast("Inventário finalizado com sucesso", "success");

                        fly01.go("@Url.Action("List", "Inventario")");
                    }
                    else {
                        fly01.loading.stop();

                        try {
                            var jsonMessage = JSON.parse(data.message);
                            var validator = that.validate();
                            var errors = {};
                            jsonMessage.innerMessage.filter(x => ((x.dataField || "") != "")).forEach(element => {
                                if ($("#" + element.dataField).length > 0) {
                                    errors[element.dataField] = element.message;
                                }
                                else {
                                    fly01.toast(element.message, "error", 8000);
                                }
                            });
                            validator.showErrors(errors);
                            jsonMessage.innerMessage.filter(x => ((x.dataField || "") == "")).forEach(element => {
                                fly01.toast(element.message, "error", 8000);
                            });
                        } catch (e) {
                            fly01.toast(data.message, "error");
                        }
                    }
                },
                error: function (jXHR, textStatus, errorThrown) {
                    $('body').addClass('loaded');
                    fly01.toast(textStatus, "error");
                }
            });
        }
    }
</script>