<script>
    @Html.Partial("Functions/_fnMain");

    function fnFormReadyAliquotaSimplesNacional() {
        $$$.fn.updateTextFields();
        if ($('input#isOnCadastroParametros').val() == "False") {
            $("input#enviarEmailContador").prop("checked", true);
        }
        fnSetInformacoes();
        $('.collapsible').collapsible();
        fnBindOverrideSubmit();
    }
    
    function fnSetInformacoes() {
        var negrito = [createElem("h5", { "class": "col s12 center orange-text light" }, "Bemacash Gestão Financeira")];
        var textAliquotas = [

            createElem("h5", { "class": "col s12 center orange-text light" }, [
                "Olá! Quando uma empresa emite notas fiscais é necessário que sejam preenchidos alguns dados, e o ",
                createElem("b", null, "Bemacash Gestão Financeira"),
                " está aqui para lhe ajudar."
                ]),
            createElem("br"),
            createElem("h5", { "class": "col s12 center orange-text light" }, [
                "As informações a seguir serão utilizadas caso sua empresa tenha a necessidade de ",
                createElem("b", null, "emissão de notas fiscais (NF-e, NFS-e)."),
                ]),
            createElem("br"),
            createElem("h5", { "class": "col s12 center orange-text light" }, "Fique tranquilo, caso sua empresa não emita notas fiscais, essas configurações apenas ficarão salvas."),
            createElem("br"), 
        ];

        var textFinal = [
            createElem("h5", { "class": "col s12 center orange-text light" }, "De acordo com os dados informados, foi realizado a configuração abaixo. Envie uma cópia dos dados ao seu contador para que seja realizada a confirmação."),
            createElem("br"),
            createElem("h5", { "class": "col s12 center white-text light" }, "------------------"),
        ];

        $("#infoFinalField").append(createElem("ul",
            { "class": "col s12" },
            createElem("li", null, [createElem("div", { "class": "col s12" }, textFinal)])
        ));

        $("#infoAliquotasField").append(createElem("ul",
            { "class": "col s12" },
            createElem("li", null, [createElem("div", { "class": "col s12" }, textAliquotas)])
        ));
    }

    function fnBindOverrideSubmit() {


        $('#stepSelecione > div.step-actions > button.btn.next-step').click(function () {
            if ($("form#fly01mdlfrmAliquotaSimplesNacional #tipoEnquadramentoEmpresaDescricao").val() == "") {
                $$$.toast("Informe o segmento de sua Empresa.", "error");
                return false;
            }
        });


        $("form#fly01mdlfrmAliquotaSimplesNacional").off("submit");
        $("form#fly01mdlfrmAliquotaSimplesNacional").on("submit", function (e) {
            e.preventDefault();
            if (!$(this).valid()) return false;
            if ($("form#fly01mdlfrmAliquotaSimplesNacional #tipoEnquadramentoEmpresaDescricao").val() == "") {
                $$$.toast("Informe o segmento de sua Empresa.", "error");
                return false;
            }

            $$$.loading.start();
            fly01mdlfrmAliquotaSimplesNacional
            var dataEmail =
            {
                simplesNacional: $("form#fly01mdlfrmAliquotaSimplesNacional input#simplesNacional").val(),
                impostoRenda: $("form#fly01mdlfrmAliquotaSimplesNacional input#impostoRenda").val(),
                csll: $("form#fly01mdlfrmAliquotaSimplesNacional input#csll").val(),
                cofins: $("form#fly01mdlfrmAliquotaSimplesNacional input#cofins").val(),
                pisPasep: $("form#fly01mdlfrmAliquotaSimplesNacional input#pisPasep").val(),
                iss: $("form#fly01mdlfrmAliquotaSimplesNacional input#iss").val(),
                email: $("form#fly01mdlfrmAliquotaSimplesNacional input#emailContador").val(),
                fcp: "0",
                inss: "0",
            };

            //Atualiza dados da tela
            if ($('input#isOnCadastroParametros').val() == "True") {
                $("form#fly01frm input#aliquotaSimplesNacional").val(dataEmail.simplesNacional);
                $("form#fly01frm input#aliquotaImpostoRenda").val(dataEmail.impostoRenda);
                $("form#fly01frm input#aliquotaCSLL").val(dataEmail.csll);
                $("form#fly01frm input#aliquotaCOFINS").val(dataEmail.cofins);
                $("form#fly01frm input#aliquotaPISPASEP").val(dataEmail.pisPasep);
                $("form#fly01frm input#aliquotaISS").val(dataEmail.iss);
                $$$._.fly01mdlfrmAliquotaSimplesNacional.close();
                $$$.fn.updateTextFields();
                $$$.loading.stop();
                return true;
            }
            else {//ou salva novo parâmetro na home
                $.ajax({
                    url: '@Url.Action("ValidaDadosEmpresa", "ParametroTributario")',
                    type: "POST",
                    data: {
                    },
                    success: function (response) {
                        debugger;
                        if (response.success) {
                            enableFields();
                            var jsonData = $("form#fly01mdlfrmAliquotaSimplesNacional").serializeObject();
                            jsonData.enviarEmailContador = $("input#enviarEmailContador").prop("checked") == true;
                            disableFields();

                            url = '@Url.Action("Create", "AliquotaSimplesNacional")';
                            $.ajax({
                                contentType: 'application/json',
                                dataType: 'json',
                                type: 'POST',
                                url: url,
                                data: JSON.stringify(jsonData),
                                success: function success(data) {
                                    if (data.success) {
                                        var strMsg = "Cadastrado com sucesso.";
                                        if (data.message !== "") strMsg = data.message;
                                        $$$.toast(strMsg, "success");
                                        $$$.loading.stop();
                                        $$$._.fly01mdlfrmAliquotaSimplesNacional.close();
                                        if (jsonData.enviarEmailContador == true) {
                                            enviaEmailContador(dataEmail);
                                        }
                                    } else {
                                        $$$.loading.stop();
                                        $$$.fn.submitErrorHandler(null, data.message);
                                    }
                                },
                                error: function error(jXHR, textStatus) {
                                    $$$.toast(textStatus, "error");
                                    $$$.loading.stop();
                                }
                            });
                        }
                        else {
                            debugger;
                            $$$.loading.stop();
                            var url = "@Url.Action("ModalAtualizaIE", "AliquotaSimplesNacional")";
                            $$$.modal(url);
                        }
                    },
                });
            }
        });
    }

    function enableFields() {
        $("form#fly01mdlfrmAliquotaSimplesNacional input#simplesNacional").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#impostoRenda").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#csll").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#cofins").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#pisPasep").removeAttr('disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#iss").removeAttr('disabled');
    }

    function disableFields() {
        $("form#fly01mdlfrmAliquotaSimplesNacional input#simplesNacional").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#impostoRenda").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#csll").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#cofins").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#pisPasep").attr('disabled', 'disabled');
        $("form#fly01mdlfrmAliquotaSimplesNacional input#iss").attr('disabled', 'disabled');
    }

    function enviaEmailContador(dataEmail) {
        $$$.loading.start();
        $.ajax({
            url: '@Url.Action("EnviaEmailContador", "ParametroTributario")',
            data: dataEmail,
            type: "POST",
            success: function (data) {
                $$$.loading.stop();
                if (data.success) {
                    $$$.toast("E-mail enviado com sucesso.", "success");
                } else {
                    $$$.fn.submitErrorHandler(null, data.message);
                }
                $$$.loading.stop();
            },
            error: function (jqxhr, textStatus, error) {
                var err = 'Ocorreu um erro ao enviar o e-mail: ' + textStatus + ", " + error;
                $$$.toast(err, "error");
                $$$.loading.stop();
            }
        });
    }
</script>