<script>
    @Html.Partial("Functions/_fnMain");

    function fnFormReadyOrdemServicoItemProduto() {
        var id = $("form#fly01mdlfrmOrdemServicoItemProduto input#id").val();

        if (id.length == 0) {
            $('form#fly01mdlfrmOrdemServicoItemProduto input#ordemServicoId').val($('form#fly01frm input#id').val());            
        }

        $$$.fn.updateTextFields();
        fnOverrideSubmitOrdemServicoItemProduto();

        $('form#fly01mdlfrmOrdemServicoItemProduto input#valor').on('change', function () {
            fnChangeTotalProduto();
        });
        $('form#fly01mdlfrmOrdemServicoItemProduto input#desconto').on('change', function () {
            fnChangeTotalProduto();
        });
        $('form#fly01mdlfrmOrdemServicoItemProduto input#quantidade').on('change', function () {
            fnChangeTotalProduto();
        });
    }

    function fnOverrideSubmitOrdemServicoItemProduto() {
        var myForm = 'form#fly01mdlfrmOrdemServicoItemProduto'

        $(myForm).off('submit');
        $(myForm).on('submit', function (e) {
            var that = $(myForm)            
            if (!that.valid())
                return false;            
            e.preventDefault();
            $$$.loading.start();
            var formData = that.serializeObject();
            $.ajax({
                type: that.attr("method"),
                contentType: 'application/json',
                dataType: 'json',
                url: that.attr("action"),
                data: JSON.stringify(formData),
                success: function (data) {                   
                    if (data.success) {
                        $$$.toast(data.message, "success");
                        $$$._.dtOrdemServicoItemProdutos.refresh();
                        $$$._.fly01mdlfrmOrdemServicoItemProduto.close();
                    } else {
                        $$$.loading.stop();
                        $$$.fn.submitErrorHandler(null, data.message);
                    }
                    $$$.loading.stop();
                    $('.modal-overlay').css('display', 'none');
                },
                error: function error(jXHR, textStatus) {
                    $$$.toast(textStatus, "error");
                    $$$.loading.stop();
                }
            })
        });
    }

</script>