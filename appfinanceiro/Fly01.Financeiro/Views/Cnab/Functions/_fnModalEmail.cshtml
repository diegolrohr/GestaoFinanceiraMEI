<script>
    var boletosEmail = "";
    function inputHiddenId(id, value) {
        var attr = { "type": "hidden", "id": id, "name": id, "value": value };
        return createElem("input", attr);
    };

    function createElement(row) {
        var formAttr = {
            "class": "cnabFormMail valign-wrapper left col s6 btn btn-narrow valid",
            "id": "btnEmail",
            "onclick": `return fnAbreModalEnviaPorEmail("${row.contaReceberId}", "${row.contaBancariaId}", "${row.contaReceber_pessoa_email}", "${row.id}")`
        };
        return createElem("button", formAttr, [inputHiddenId("emailId", row.email), createElem("i", { "class": "material-icons" }, "email")]);
    }

    function fnModalEmail(data, type, row, meta) {
        return createElement(row).outerHTML;
    }

    function fnAbreModalEnviaPorEmail(contaReceberId, contaBancariaId, email, id) {
        if (email === "")
            email = "";
        
        if (id !== "undefined") {
            $.ajax({
                type: "GET",
                dataType: "json",
                url: '@Url.Action("VerificarBoletosPessoa", "Cnab")?id=' + id,
                success: function success(data) {
                    boletosEmail = data.data;
                    if (data.success) {
                        if (data.data !== null) {
                            if (data.data.length > 0)
                                $$$.confirm("Confirmar envio de múltiplos boletos ", "Existe mais de um boleto para este cliente. Deseja enviar todos?", "fnConfirmEnvioBoletos('" + email + "', '" + contaBancariaId + "')");
                            else {
                                var url = "@Url.Action("ModalConfigEmail", "Cnab")?email=" + email + "&contaReceberId=" + contaReceberId + "&contaBancariaId=" + contaBancariaId;
                                $$$.modal(url);
                            }
                        } else {
                            var url = "@Url.Action("ModalConfigEmail", "Cnab")?email=" + email + "&contaReceberId=" + contaReceberId + "&contaBancariaId=" + contaBancariaId;
                            $$$.modal(url);
                        }

                    } else {
                        var url = "@Url.Action("ModalConfigEmail", "Cnab")?email=" + email + "&contaReceberId=" + contaReceberId + "&contaBancariaId=" + contaBancariaId;
                        $$$.modal(url);
                    }

                    // $("a.modal-action.modal-close.btn")[0].text = "não enviar todos";
                    //$("a.modal-action.modal-close.btn")[1].text = "enviar";

                    $("a.modal-action.modal-close.btn-secondary").click(function () {
                        var url = "@Url.Action("ModalConfigEmail", "Cnab")?email=" + email + "&contaReceberId=" + contaReceberId + "&contaBancariaId=" + contaBancariaId;
                        $$$.modal(url);
                    });
                }
            });
        } 
    }

    function fnConfirmEnvioBoletos(email, contaBancariaId) {
        var ids = [];
        boletosEmail.forEach(function (item) {
            ids.push(item.Id);
        });

        var url = "@Url.Action("ModalConfigEmail", "Cnab")?email=" + email + "&contaBancariaId=" + contaBancariaId + "&ids=" + ids.toString();
        $$$.modal(url);
    }
</script>