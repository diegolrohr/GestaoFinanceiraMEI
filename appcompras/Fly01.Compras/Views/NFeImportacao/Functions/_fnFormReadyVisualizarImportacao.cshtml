<script>
    @Html.Partial("Functions/_fnMain");

    function listProdutos() {
        var t = $('#fly01mdlfrmVisualizarImportacao #id').val();
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetNFeImportacaoProdutos", "NFeImportacaoProduto")?id=' + t ,
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response) {
                    $("#produtosImportacaoDataTable").DataTable().destroy();

                    response.data = fixFields(response.data);

                    var table = $("#produtosImportacaoDataTable").DataTable({
                        bSort: false,
                        paging: false,
                        bLengthChange: false,
                        searching: false,
                        ordering: false,
                        info: false,
                        data: response.data,
                        columns: [
                            { title: "Produto", data: "descricao" },
                            { title: "Quant.", data: "quantidade" },
                            { title: "Un.", data: "unidadeMedida_abreviacao" },
                            { title: "Valor", data: "valor" },
                            { title: "Valor Venda", data: "valorVenda" },
                            { title: "Mov. Estoque", data: "movimentaEstoque" },
                            { title: "At. Produto", data: "atualizaDadosProduto" },
                            { title: "At. Valor Venda", data: "atualizaValorVenda" }
                        ]
                    });
                } else {
                    $$$.toast(response.message, 'error');
                }
            },
            error: function (jXHR, textStatus, errorThrown) {
                $$$.toast(errorThrown, 'error');
            }
        });
    }

    function listCobrancas() {
        var t = $('#fly01mdlfrmVisualizarImportacao #id').val();
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetNFeImportacaoCobrancas", "NFeImportacaocobranca")?id=' + t ,
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response) {
                    $("#cobrancasImportacaoDataTable").DataTable().destroy();

                    response.data = fixFields(response.data);

                    var table = $("#cobrancasImportacaoDataTable").DataTable({
                        bSort: false,
                        paging: false,
                        bLengthChange: false,
                        searching: false,
                        ordering: false,
                        info: false,
                        data: response.data,
                        columns: [
                            { title: "Número", data: "numero" },
                            { title: "Valor", data: "valor" },
                            { title: "Vencimento", data: "dataVencimento" },
                        ]
                    });
                } else {
                    $$$.toast(response.message, 'error');
                }
            },
            error: function (jXHR, textStatus, errorThrown) {
                $$$.toast(errorThrown, 'error');
            }
        });
    }

    function fnFormReadyVisualizarImportacao() {
        listProdutos();
        listCobrancas();
    }

    function fixFields(data) {
        for (var i = 0; i < data.length; i++) {
            if (data[i].movimentaEstoque)
                data[i].movimentaEstoque = "Sim";
            else
                data[i].movimentaEstoque = "Não";

            if (data[i].atualizaDadosProduto)
                data[i].atualizaDadosProduto = "Sim";
            else
                data[i].atualizaDadosProduto = "Não";

            if (data[i].atualizaValorVenda)
                data[i].atualizaValorVenda = "Sim";
            else
                data[i].atualizaValorVenda = "Não";
        }
        return data;
    }
</script>