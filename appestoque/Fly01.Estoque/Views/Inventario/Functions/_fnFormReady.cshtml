<script>
    @Html.Partial("Functions/_fnMain");

    function inventarioItensShow() {
        $('#dtInventarioItem_wrapper').parent().show();
        $('#fly01frmInventarioItem').show();
    }

    function inventarioItensHide() {
        $('#fly01frmInventarioItem').hide();
        $('#dtInventarioItem').hide();
    }

    function fnOverrideSubmit() {
        var myForm = "form#fly01frmInventario";

        $(myForm).off("submit");
        $(myForm).on("submit", function (e) {
            var that = $(myForm)

            if (!that.valid())
                return;
            e.preventDefault();
            fly01.loading.start();
            var formData = that.serializeObject();
            $.ajax({
                type: that.attr("method"),
                contentType: 'application/json',
                dataType: 'json',
                url: that.attr("action"),
                data: JSON.stringify(formData),
                success: function (data) {
                    if (data.success) {
                        fly01.toast(data.message, "success");

                        fly01.go("@Url.Action("Form", "Inventario")", data.id);
                    } else {
                        fly01.loading.stop();
                        try {
                            var jsonMessage = JSON.parse(data.message);
                            var validator = that.validate();
                            var errors = {};
                            jsonMessage.innerMessage.filter(x => ((x.dataField || "") != "")).forEach(element => {
                                if ($("#" + element.dataField).length > 0) {
                                    errors[element.dataField] = element.message;
                                }
                                else {
                                    fly01.toast(element.message, "error", 8000);
                                }
                            });
                            validator.showErrors(errors);
                            jsonMessage.innerMessage.filter(x => ((x.dataField || "") == "")).forEach(element => {
                                fly01.toast(element.message, "error", 8000);
                            });
                        } catch (e) {
                            fly01.toast(data.message, "error");
                        }
                    }
                    fly01.loading.stop();
                },
                error: function error(jXHR, textStatus) {
                    fly01.toast(textStatus, "error");
                    fly01.loading.stop();
                }
            })
        });
    };

    function changeSaveButton() {
        var buttonCancel = $('ul.fly01-buttons').children().slice(1).find('#cancel');

        var cancelFunction = buttonCancel.attr('onclick');

        var btnSalvar = $('ul.fly01-buttons').children().find('#save');

        btnSalvar.attr('id', buttonCancel.attr('id'));
        btnSalvar.attr('onclick', cancelFunction);
        btnSalvar.html(buttonCancel.html());
    }

    function fnInventarioFechado() {
        if ($('input#inventarioStatus').val() !== "Finalizado")
            return;

        $('form#fly01frmInventario').find('input').attr('disabled', 'disabled');

        changeSaveButton();

        $('ul.fly01-buttons').children().slice(1).hide();
    };

    function isCreate() {
        var idSelector = "input#id";
        var id = $(idSelector).val();

        if (id.length == 0)
            return true;

        return false;
    };

    function fnFormReady() {
        if (isCreate()) {
            fnOverrideSubmit();
            inventarioItensHide();
        } else {
            inventarioItensShow();
            fly01._.dtInventarioItem.refresh()
            fnInventarioFechado();
        }
    };

</script>