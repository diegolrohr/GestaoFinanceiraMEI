<script>

    function inputHiddenId(id, value) {
        var attr = { "type": "hidden", "id": id, "name": id, "value": value };

        return createElem("input", attr);
    };

    function submitButton() {
        var attr = { "type": "submit", "class": "btn btn-narrow valid", "id": "" }

        return createElem("button", attr,
            createElem("i", { "class": "material-icons" }, "print")
        );
    };

    function createForm(row) {
        var action = "@Url.Action("Edit", "Cnab")" + "/{" + row.id + "}";

        var formAttr = {
            "method": "GET", "action": action,
            "class": "cnabForm valign-wrapper right col s12",
            //"style": "padding-left: 0;"
        }

        return createElem("form", formAttr,[ //Inner Content
            inputHiddenId("contaReceberId", row.id),
            inputHiddenId("contaBancariaId", $("#bancoId").val()),
            submitButton()
        ]);
    };

    function fnImprimirBoleto(data, type, row, meta) {
        return createForm(row).outerHTML;
    };

    $(document).off("submit", "form.cnabForm");
    $(document).on("submit", "form.cnabForm", function (e) {
        var that = $(this);
        that.loading("start");
        e.preventDefault();

        if (!that.valid()) {
            that.loading("stop");
            return false;
        }
        else {
            $.ajax({
                type: "GET",
                dataType: "json",
                url: '@Url.Action("ImprimeBoleto", "Cnab")',
                contentType: "application/json",
                data: { contaReceberId: that.serializeObject().contaReceberId, contaBancariaId: $("#bancoId").val() },
                success: function success(data) {
                    if (data.success) {
                        var strMsg = "Boleto emitido com sucesso.";
                        fly01.toast(strMsg, "success");
                        that.loading("stop");

                        if (data.message !== "" && data.message !== undefined) {
                            var win = window.open("", "_blank");
                            win.document.write(data.message);
                            win.print();
                            win.close();
                        }
                    } else {
                        that.loading("stop");

                        try {
                            var jsonMessage = JSON.parse(data.message);
                            var validator = that.validate();
                            var errors = {};
                            jsonMessage.innerMessage.filter(x => ((x.dataField || "") != "")).forEach(element => {
                                if ($("#" + element.dataField).length > 0) {
                                    errors[element.dataField] = element.message;
                                }
                                else {
                                    fly01.toast(element.message, "error", 8000);
                                }
                            });
                            validator.showErrors(errors);
                            jsonMessage.innerMessage.filter(x => ((x.dataField || "") == "")).forEach(element => {
                                fly01.toast(element.message, "error", 8000);
                            });
                        } catch (e) {
                            fly01.toast(data.message, "error");
                        }
                    }
                    that.loading("stop");
                },
                error: function error(jXHR, textStatus) {
                    fly01.toast(textStatus, "error");
                    that.loading("stop");
                }
            });
        }
    });
</script>