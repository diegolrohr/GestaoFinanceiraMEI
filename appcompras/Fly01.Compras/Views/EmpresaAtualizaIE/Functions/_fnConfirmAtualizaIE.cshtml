<script>
    function fnConfirmAtualizaIE() {
        if (!$("form#fly01mdlfrmAtualizaIE").valid()) {
            return;
        }
        else {
            $$$.loading.start();
            $.ajax({
                type: "POST",
                url: "@Url.Action("PostAtualizacaoIE", "EmpresaAtualizaIE")",
                data: {
                    inscricaoEstadual: $('#inscricaoEstadualId').val(),
                    cidadeId: $('#cidadeId').val()
                },
                success: function (response) {
                    if($('#fly01mdlfrmAliquotaSimplesNacional').length == 1){//tela das aliquotas
                        telaAliquotaSimplesNacional(response);
                    }
                    else if ($('#fly01tabsParametros').length == 1) {//tela dos parâmetros
                        telaParametros(response);
                    }
                    else if ($('#fly01frmCertificadoDigital').length == 1) {//tela do certificado
                        telaCertificadoDigital(response);
                    }
                }
            });
        }
    }

    function telaAliquotaSimplesNacional(response){
        if (response.success) {
            var url = '@Url.Action("ExisteParametroSalvo", "EmpresaAtualizaIE")';
            $.ajax({
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'GET',
                url: url,
                success: function success(data) {
                    if (data.existeParametro) {
                        $$$.loading.stop();
                        $$$._.fly01mdlfrmAtualizaIE.close();
                        $$$._.fly01mdlfrmAliquotaSimplesNacional.close();
                        $$$.toast("Já existe parâmetros configurados para essa Inscrição Estadual.", "success");
                    }
                    else {
                        $$$.loading.stop();
                        $$$._.fly01mdlfrmAtualizaIE.close();
                        $$$.toast("Inscrição Estadual atualizada com sucesso.", "success");
                    }
                },
                error: function error(jXHR, textStatus) {
                    $$$.toast(textStatus, "error");
                    $$$.loading.stop();
                }
            });
        }
        else {
            $$$.loading.stop();
            $$$.fn.submitErrorHandler(null, response.message);
        }
    }

    function telaCertificadoDigital(response) {
        if (response.success) {
            $$$._.fly01mdlfrmAtualizaIE.close();
            fnAtualizaCertificado();
        }
        else {
            fnGetStatusCertificado();
            $$$.fn.submitErrorHandler(null, response.message);
        }
    }

    function telaParametros(response) {
        if (response.success) {
            $$$._.fly01mdlfrmAtualizaIE.close();
            fnAtualizaParametro();
        }
        else {
            $$$.loading.stop();
            $$$.fn.submitErrorHandler(null, response.message);
        }
    }
</script>
