<script>
    function ocultaCamposRenegociacao() {
        $('#dadosRenegociacaoLabelField').hide();
        $('#tipoRenegociacaoValorDiferencaField').hide();
        $('#tipoRenegociacaoCalculoField').hide();
        $('#valorDiferencaField').hide();
        $('#valorFinalField').hide();
    }

    function exibeCamposRenegociacao() {
        $('#dadosRenegociacaoLabelField').show();
        $('#tipoRenegociacaoValorDiferencaField').show();
        $('#tipoRenegociacaoCalculoField').show();
        $('#valorDiferencaField').show();
        $('#valorFinalField').show();
    }
    
    function getStatusConta() {
        return $('#fly01mdlfrm #statusContaBancaria').val();
    }

    function getQueryStringFilterBaixas() {
        return "@Url.Action("ListContaBaixas")?contaFinanceiraId=" + $('#fly01mdlfrm #id').val();
    }

    function getContaBaixas() {
        $('#fly01mdlfrm #datatableContaBaixas').DataTable().destroy();

        table = $('#fly01mdlfrm #datatableContaBaixas').DataTable({
            bSort: true,
            bLengthChange: false,
            processing: true,
            serverSide: true,
            orderCellsTop: true,
            responsive: true,
            //pageLength: 10,
            paging: false,
            info: false,
            responsive: true,
            ajax: {
                url: getQueryStringFilterBaixas(),
                cache: false,
                "dataSrc": function (json) {

                    if (json.success === false)
                        alert(json.message);

                    return json.data;
                }
            },
            sDom: "<\"H\">rt<\"F\"ip>",
            displayStart: 0,
            order: [],
            searching: false,
            columns: [
                { data: "data", orderable: false },
                { data: "valor", orderable: false },
                { data: "contaBancaria_NomeConta", orderable: false },
                { data: "observacao", orderable: false }
            ]
        });
    }

    function getRenegociacoRelacionamento() {
        $.ajax({
            type: "POST",
            url: "@Url.Action("ListRenegociacaoRelacionamento")?contaFinanceiraId=" + $('#fly01mdlfrm #id').val(),
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response.success) {
                    if (response.recordsTotal > 0) {
                        $("#datatableRenegociacaoRelacionamento").DataTable().destroy();

                        var table = $("#datatableRenegociacaoRelacionamento").DataTable({
                            bSort: false,
                            paging: false,
                            bLengthChange: false,
                            searching: false,
                            ordering: false,
                            info: false,
                            data: response.data,
                            columns: [
                                { data: "descricao", orderable: false },
                                { data: "valorPrevisto", orderable: false },
                                { data: "dataVencimento", orderable: false },
                                { data: "descricaoParcela", orderable: false },
                                { data: "formaPagamento_descricao", orderable: false },
                                { data: "pessoa_nome", orderable: false },
                            ]
                        });
                        $('#tipoRenegociacaoValorDiferencaField select#tipoRenegociacaoValorDiferenca').val(response.renegociacao.TipoRenegociacaoValorDiferenca == 1 ? "Acrescimo" : "Desconto");
                        $('#tipoRenegociacaoValorDiferencaField .select-dropdown').val(response.renegociacao.TipoRenegociacaoValorDiferenca == 1 ? "Acréscimo" : "Desconto");
                        $('#tipoRenegociacaoCalculoField select#tipoRenegociacaoCalculo').val(response.renegociacao.TipoRenegociacaoCalculo == 1 ? "Valor" : "Percentual");
                        $('#tipoRenegociacaoCalculoField .select-dropdown').val(response.renegociacao.TipoRenegociacaoCalculo == 1 ? "Valor" : "Percentual");
                        //$('select#tipoRenegociacaoValorDiferenca').val(response.renegociacao.TipoRenegociacaoValorDiferenca);
                        //$('select#tipoRenegociacaoCalculo').val(response.renegociacao.TipoRenegociacaoValorDiferenca);
                        $('#fly01mdlfrm #valorDiferenca').val(response.renegociacao.ValorDiferenca);
                        $('#fly01mdlfrm #valorFinal').val(response.renegociacao.ValorFinal);

                        if (getStatusConta() == "Renegociado") {
                            $('#fly01mdlfrm #lblRenegociacaoRenegociadasField').show();
                        }
                        else {
                            $('#fly01mdlfrm #lblRenegociacaoOrigemField').show();
                        }
                        exibeCamposRenegociacao();
                        $$$.fn.updateTextFields();
                        //posiciona os selects nos valores setados manualmente
                        $('select#tipoRenegociacaoValorDiferenca').material_select();
                        $('select#tipoRenegociacaoCalculo').material_select();
                        $('#fly01mdlfrm #datatableRenegociacaoRelacionamentoField').show();
                    }
                }
            },
            error: function (jXHR, textStatus, errorThrown) {
                $$$.toast(errorThrown, 'error');
            }
        });
    }

    function fnFormReadyVisualizar() {
        if (getStatusConta() == "BaixadoParcialmente" || getStatusConta() == "Pago") {
            $('#fly01mdlfrm #relacaoBaixaLabelField').show();
            $('#fly01mdlfrm #btnListaBaixasField').show();
            $('#fly01mdlfrm #datatableContaBaixasField').show();
            getContaBaixas();
            $('#fly01mdlfrm #btnListaBaixasField').hide();
        }
        else {
            $('#fly01mdlfrm #relacaoBaixaLabelField').hide();
            $('#fly01mdlfrm #btnListaBaixasField').hide();
            $('#fly01mdlfrm #datatableContaBaixasField').hide();
        }

        $('#fly01mdlfrm #lblRenegociacaoOrigemField').hide();
        $('#fly01mdlfrm #lblRenegociacaoRenegociadasField').hide();
        $('#fly01mdlfrm #datatableRenegociacaoRelacionamentoField').hide();
        ocultaCamposRenegociacao();

        getRenegociacoRelacionamento();
    }
</script>