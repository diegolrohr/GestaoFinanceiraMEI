<script>
    @Html.Partial("Functions/_fnMain");

    function fnConfiguraTipoTributacaoICMSProduto() {
        var tipoTribICMS = $('form#fly01mdlfrmOrdemVendaProduto #grupoTributarioTipoTributacaoICMS').val();
        $('form#fly01mdlfrmOrdemVendaProduto #valorCreditoICMSField').hide();
        $('form#fly01mdlfrmOrdemVendaProduto #valorICMSSTRetidoField').hide();
        $('form#fly01mdlfrmOrdemVendaProduto #valorBCSTRetidoField').hide();
        $('form#fly01mdlfrmOrdemVendaProduto #valorBCFCPSTRetidoAnteriorField').hide();
        $('form#fly01mdlfrmOrdemVendaProduto #valorFCPSTRetidoAnteriorField').hide();

        //101 e 201 e 900
        if (tipoTribICMS == "TributadaComPermissaoDeCredito" || tipoTribICMS == "TributadaComPermissaoDeCreditoST" || tipoTribICMS == "Outros") {
            $('form#fly01mdlfrmOrdemVendaProduto #valorCreditoICMSField').show();
        }
        //500
        if (tipoTribICMS == "ICMSSubstituidoOuAntecipado") {
            $('form#fly01mdlfrmOrdemVendaProduto #valorICMSSTRetidoField').show();
            $('form#fly01mdlfrmOrdemVendaProduto #valorBCSTRetidoField').show();
            $('form#fly01mdlfrmOrdemVendaProduto #valorBCFCPSTRetidoAnteriorField').show();
            $('form#fly01mdlfrmOrdemVendaProduto #valorFCPSTRetidoAnteriorField').show();
        }
    }

    function fnFormReadyOrdemVendaProduto() {

        var id = $("form#fly01mdlfrmOrdemVendaProduto input#id").val();
        var emiteNotaFiscal = $('#emiteNotaFiscal').val() == "True";

        if (id.length == 0) {
            if (emiteNotaFiscal) {
                $$$.loading.start();
                $.ajax({
                    url: '@Url.Action("GetParametrosTributarios", "OrdemVendaProduto")',
                    type: "GET",
                    data: {}
                })
                .done(function (data) {
                    if (data.success) {
                        if (data.imposto != null) {
                            $('input#fcp').val(data.imposto.AliquotaFCP);
                            $('input#icms').val(data.imposto.AliquotaSimplesNacional);
                            $$$.fn.updateTextFields();
                        }
                    }
                    else {

                        $$$.fn.submitErrorHandler(null, data.message);
                    }
                    $$$.loading.stop();
                })
                .fail(function (jqxhr, textStatus, error) {
                    var err = 'Ocorreu um erro na requisição: ' + textStatus + ", " + error;
                    $$$.toast(err, "error");
                    $$$.loading.stop();
                });
            }

            $('form#fly01mdlfrmOrdemVendaProduto input#ordemVendaId').val($('form#fly01frm input#id').val());
            $('form#fly01mdlfrmOrdemVendaProduto input#grupoTributarioIdProduto').val($('form#fly01frm input#grupoTributarioPadraoId').val());
            $('form#fly01mdlfrmOrdemVendaProduto input#grupoTributarioDescricaoProduto').val($('form#fly01frm input#grupoTributarioPadraoDescricao').val());
            $('form#fly01mdlfrmOrdemVendaProduto #grupoTributarioTipoTributacaoICMS').val($('form#fly01frm #grupoTributarioPadraoTipoTributacaoICMS').val());
        }

        fnConfiguraTipoTributacaoICMSProduto();
        if (!emiteNotaFiscal) { fnHideCamposEmissaoNotaProduto(); }

        $$$.fn.updateTextFields();
        fnOverrideSubmitOrdemVendaProduto();

        $('form#fly01mdlfrmOrdemVendaProduto input#valor').on('change', function () {
            fnChangeTotalProduto();
        });
        $('form#fly01mdlfrmOrdemVendaProduto input#desconto').on('change', function () {
            fnChangeTotalProduto();
        });
        $('form#fly01mdlfrmOrdemVendaProduto input#quantidade').on('change', function () {
            fnChangeTotalProduto();
        });
        if (emiteNotaFiscal) {
            setNFERequiredFields("fly01mdlfrmOrdemVendaProduto", ["produtoDescricao", "grupoTributarioDescricaoProduto", "quantidade", "valorCreditoICMS", "valorBCSTRetido", "valorICMSSTRetido", "valorBCFCPSTRetidoAnterior", "valorFCPSTRetidoAnterior", "icms", "fcp"]);
        }
    }

    function fnHideCamposEmissaoNotaProduto() {
        $('form#fly01mdlfrmOrdemVendaProduto #grupoTributarioIdProdutoField').hide();
        $('form#fly01mdlfrmOrdemVendaProduto #icmsField').hide();
        $('form#fly01mdlfrmOrdemVendaProduto #fcpField').hide();
    }

    function fnSetNaturezaOperacao(idItem) {
        //adicionando o primeiro ou editando o único adicionado
        if ($('input#exibeStepProdutos').val() == "True" && $('#tipoOrdemVenda').val() == "Pedido" && ($$$._.dtOrdemVendaProdutos.ajax.json().recordsTotal == 0 && idItem.length == 0) || ($$$._.dtOrdemVendaProdutos.ajax.json().recordsTotal == 1 && idItem.length != 0)) {
            var cfopDescricao = $('input#cfopDescricao').val();
            $('input#naturezaOperacao').val(cfopDescricao.substring(0, (cfopDescricao.length > 60 ? 60 : cfopDescricao.length)));
            $$$.fn.updateTextFields();
        }
    }

    function fnOverrideSubmitOrdemVendaProduto() {
        var myForm = 'form#fly01mdlfrmOrdemVendaProduto'

        $(myForm).off('submit');
        $(myForm).on('submit', function (e) {
            var that = $(myForm)

            if (!that.valid())
                return false;

            e.preventDefault();
            $$$.loading.start();
            var formData = that.serializeObject();

            $.ajax({
                type: that.attr("method"),
                contentType: 'application/json',
                dataType: 'json',
                url: that.attr("action"),
                data: JSON.stringify(formData),
                success: function (data) {
                    if (data.success) {
                        fnSetNaturezaOperacao(formData.id);
                        $$$.toast(data.message, "success");
                        $$$._.dtOrdemVendaProdutos.refresh();
                        $$$._.fly01mdlfrmOrdemVendaProduto.close();
                    } else {
                        $$$.loading.stop();
                        $$$.fn.submitErrorHandler(null, data.message);
                    }
                    $$$.loading.stop();
                    $('.modal-overlay').css('display', 'none');
                },
                error: function error(jXHR, textStatus) {
                    $$$.toast(textStatus, "error");
                    $$$.loading.stop();
                }
            })
        });
    }

</script>